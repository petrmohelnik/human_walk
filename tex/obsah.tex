%=========================================================================
% (c) Michal Bidlo, Bohuslav Køena, 2008

\chapter{Úvod}
Poèítaèová animace má velké vyu¾ití pro poèítaèové hry a filmy. Existuje mno¾ství zpùsobù tvorby a zobrazování animace. Tato práce se zabývá tvorbou animace lidské chùze. Lidská chùze je jedna z nejpou¾ívanìj¹ích a nejdùle¾itìj¹ích animací. Lidé jsou velmi vnímaví na správnost lidské chùze a snadno rozpoznají, kdy je animace nepøirozená. To klade velký dùraz na pøesnost.

Existují rùzné pøístupy k tvorbì animace lidské chùze. Tyto pøístupy se li¹í v kompromisu mezi pøirozeností, kontrolou nad animací a výpoèetním èasem. Populární zpùsob tvorby animace je motion capture, kde se zachytává pohyb herce pomocí kamer. Aèkoliv tento zpùsob dosahuje velké pøirozenosti, je velmi drahý. Fyzikální simulace umo¾òuje velmi dobrou interakci s prostøedím, ale je velmi výpoèetnì nároèná. Tato práce se zabývá procedurální tvorbou. Pøi tomto zpùsobu se vyu¾ívá znalostí o cyklu lidské chùze, který je studován ji¾ od starovìku. Procedurální systém umo¾òuje jednodu¹e vytvoøit animaci pomocí specifikace mno¾ství parametrù. Je výpoèetnì nenároèná, ale není pøíli¹ vhodná pro interakci s prostøedím. Také není tak detailní jako v motion capture.  V této práci si klademe za cíl vytvoøení systému, který umo¾ní rychlou a jednoduchou tvorbu specifické animace lidské chùze i u¾ivatelùm bez animaèních znalostí a schopností, kterou budou moci pou¾it napø. v poèítaèové høe.

Druhá kapitola se zamìøuje na skeletální animaci. Pøibli¾uje co je to kostra a jak se na ní pøipojí kù¾e. Dále obsahuje struèný pøehled metod tvorby animace. Tøetí kapitola se vìnuje kinematikám. Definuje co je to inverzní kinematika a popisuje nìkteré metody jejího øe¹ení. Ve ètvrté kapitole je podrobnì popsána lidská chùze a její fáze. Také obsahuje popis nìkterých existujících implementací procedurální animace vyu¾ívající tyto znalosti. 
\chapter{Skeletální animace}
Skeletální animace je zpùsob animace, který vyu¾ívá dvì základní komponenty: model (nejèastìji polygonální) nazýván kù¾e a kostru, na kterou je kù¾e pøipojena. Jestli¾e se pohne kost, pohne se také pøipojená kù¾e. V klasické animaci, je vytvoøen model pro ka¾dý klíèový snímek animace a tyto modely se za postupnì zobrazují. Oproti tomu se skeletální animace skládá pouze z jednoho modelu a pøipojené kostry, pro kterou jsou ulo¾eny pozice kostí v klíèových snímcích napø. cyklu chùze. Ka¾dý tento snímek definuje pozici ka¾dé kosti v konkrétní èas. Díky tomu má mnohem ni¾¹í pamì»ovou nároènost. Také skeletální animace umo¾òuje vysokou interakci s prostøedím. Kost se mù¾e zarazit o pøeká¾ku apod. Skeletální animace také mohou být pou¾ité na více rùzných modelech. Nìkdy programy poskytují pøedpøipravenou kostru, okolo které se vytvoøí model. Skeletální animace má také své nevýhody. Pohyby kostí a pøipojených vrcholù spotøebovávají výpoèetní výkon. V animacích obecnì se musí øe¹it interpolace mezi dvìma klíèovými snímky, proto¾e zobrazení snímku mù¾e probìhnout v libovolný èas.
\section{Kostra}
Kostra je abstraktní model lidského, zvíøecího tìla nebo jiného objektu. Jedná se o stromovou strukturu. Uzly jsou nazývány kosti nebo klouby. Ke kostem jsou pøiøazeny vrcholy. Kosti mají stupnì volnosti, které urèují v jakém smìru a jak moc se mù¾ou rotovat. Pøipojování modelu na kostru se nazývá skinning.

\begin{figure}[h]
\begin{center}
\scalebox{0.5}{\includegraphics{fig/bone_structure.png}}
\caption{Pøíklad hierarchie kostry} \label{bone_structure}
\end{center}
\end{figure}

Ka¾dá kost má lokální transformaci: posunutí, rotaci a zvìt¹ení. Tato transformace se mù¾e ulo¾it jako matice a urèuje transformaci vùèi rodièovské kosti, pokud existuje. Pro realistické modely èlovìka se vìt¹inou pou¾ívá pouze rotace. Výsledná globální transformace kosti se získá kombinací rodièovské globální transformace a vlastní lokální transformace. Globální transformace v¹ech kostí se vypoèítá procházením stromové struktury kostry a postupným násobením transformaèních matic od koøene k listùm. Pro koøenovou kost je lokální transformace její globální. 

Pøed pøipojením kù¾e na kostru se kostra nastaví do pozice nazývané bind pose \cite{bindPose}. To je základní pozice kostry pøed jakýmkoliv pohybem. V tuto chvíli se na kostru pøipojí kù¾e. Následnì jsou urèeny a ulo¾eny bind pose matice $\mathbf{B}$ pro ka¾dou kost. Ty urèují jejich transformaci z poèátku souøadného systému kostry do bind pose. Matice $\mathbf{B}_a$ ka¾dé kosti urèuje její aktuální transformaci z poèátku souøadného systému kostry. Pøed prvním pohybem kostry jsou shodné s $\mathbf{B}$. Chceme-li zmìnit pózu kostry (matici $\mathbf{B}_a$ nìjaké kosti) a tím i pøipojeného modelu (kù¾e), musí se vrcholy transformovat ze souøadného systému modelu do souøadného systému kostry. K tomu se pou¾ije inverzní bind pose matice $\mathbf{B}_i$. Ta urèuje transformaci kosti potøebnou pro pøesun kosti z bind pose do poèátku souøadného systému. Tedy invertuje transformaci, která byla na model aplikována v bind pose. Matematický zápis transformace $\mathbf{T}$ urèující novou pozici kosti je následující:
\begin{eqnarray}
\mathbf{T} &=& \mathbf{B}_i \mathbf{B}_a\label{r.transform_mat}
\end{eqnarray}
Poté se mù¾e pou¾ít $\mathbf{T}$ na výpoèet nové pozice vrcholù kù¾e. Vrchol bude poøád ve stejné relativní pozici vùèi kosti. Transformování se èasto provádí na grafické kartì ve vertex shaderu.
 \begin{figure}[h]
\begin{center}
\scalebox{0.5}{\includegraphics{fig/transform_pose.png}}
\caption{Transformace pøedloktí. Prvnì se aplikuje inverzní bind pose matice a poté aktuální transformace kosti.} \label{transform_pose}
\end{center}
\end{figure}
\section{Skinning}
Skinning \cite{skinningMethods} je nazýván proces pøidìlování kostí vrcholùm kù¾e a urèování jejich vah. Tento proces mù¾e probíhat algoritmicky nebo ruènì v nìkterém z modelovacích programù. 

Nejjednodu¹¹í zpùsob pøiøazení kù¾e ke kostøe je ka¾dé kosti pøiøadit samostatný pevný objekt jako je napø. válec. Na ka¾dý takový objekt se poté aplikuje transformace pøiøazené kosti. Tento pøístup není vhodný pro realistické animování.

Pokroèilej¹í, ale stále základní metoda je Jednoduchý skinning, který ji¾ pou¾ívá kù¾i, tedy jeden model pro celou kostru. Pøiøazuje jeden vrchol k jedné kosti. Ka¾dý vrchol se poté transformuje podle pøiøazené kosti. Je pou¾íván napøíklad ve star¹ích hrách. Je dobøe pou¾itelný pro modely s nízkým poètem trojúhelníkù. U detailnìj¹ích modelù zpùsobuje nepìkné deformace v kloubech a animace vypadá nepøirozenì. 

\subsection{Linear blend skinning} \label{linear_blend_skinning}
Linear blend skinning je modernìj¹í algoritmus. Ka¾dému vrcholu umo¾òuje pøiøazení více kostí. Ka¾dá dvojice kost a vrchol má pøiøazenou váhu. Váha urèuje jak velký vliv má pohyb konkrétní kosti na výslednou pozici vrcholu. Na vstupu oèekává následující data: 
\begin{itemize}
\item Kù¾e v bind pose, typicky reprezentovaná jako polygonální model. Propojení mezi vrcholy se v prùbìhu nemìní, pouze pozice vrcholù. 
\item Transformace kostí, reprezentované jako matice $\mathbf{T}_1,\ldots,\mathbf{T}_m$ urèené podle rovnice \ref{r.transform_mat}. Tyto matice jsou typicky jediná velièina, která se v prùbìhu animace mù¾e mìnit. 
\item \label{weight_sum} Váhy vrcholù, pro ka¾dý vrchol $\mathbf{v}_i$ máme váhy $w_{i,1},\ldots,w_{i,m} \in \mathbb{R}$. Ka¾dá váha $W_{i,j}$ urèuje vliv kosti $j$ na vrchol $i$. Celkový souèet v¹ech vah je 1, pøièem¾ ¾ádná váha není záporná. 
\end{itemize}
Mno¾ství kostí ovlivòující jeden vrchol se mù¾e významnì li¹it, napø. od 1 do 10. Kvùli limitacím grafického hardwaru se èasto uva¾uje ¾e jich není více ne¾ 4. Transformovaná pozice vrcholu $\mathbf{v}'_i$ se urèí podle následující rovnice:
\begin{eqnarray}
\mathbf{v}'_i &=& \Bigg(\sum_{j=1}^mw_{i,j} \mathbf{T}_j\Bigg)\mathbf{v}_i\label{r.linear_blend_skinning}
\end{eqnarray}
 Tato metoda podává dobré výsledky, pokud míchané transformace nejsou pøíli¹ rozdílné. Problémy nastávají jestli¾e potøebujeme míchat transformace, které se významnì li¹í v jejich rotaci. Z lineární kombinace rotací nevzniká rotace. To je dùsledkem faktu, ¾e Lieova grupa 3D transformací, $SO(3)$, není lineární prostor, ale zakøivená varieta. Pokud jsou si rotace blízké není to problém. Uva¾ujme ale tyto dvì rotace.
$$\mathbf{R}_1\left[\begin{array}{ccc}
1 & 0 & 0\\
0 & 1 & 0\\
0 & 0 & 1~\end{array}\right], \quad \mathbf{R}_2 \left[\begin{array}{ccc}
-1 & 0 & 0\\
0 & -1 & 0\\
0 & 0 & 1~\end{array}\right]$$ 
  $\mathbf{R}_1$ je maticí identity a $\mathbf{R}_2$ je rotace okolo osy Z o 180°. Lineární míchání $0.5 \cdot \mathbf{R}_1 + 0.5 \cdot \mathbf{R}_2$ nám dá za výsledek matici hodnosti 1, která promítá 3D prostor na osu Z. To má za následek ztrátu objemu modelu. Velké relativní rotace nejsou vzácné, proto¾e klouby jako ramena a zápìstí mají velký rozsah pohybu. Tyto problémy je mo¾né øe¹it zavedením více parametrù ne¾ má linear blend skinning. Takové metody se nazývají multilineární. Tyto metody ale nemusí být ¾ádoucí kvùli nutnosti vytváøet a ukládat více vah pro ka¾dý vrchol. 
  
 \begin{figure}[h]
\begin{center}
\scalebox{0.5}{\includegraphics{fig/dual_quat.png}}
\caption{Zleva doprava: model v bind pose, linear blend skinning a dual quaternion. Pøevzato z \cite{skinningMethods}.} \label{bone_structure}
\end{center}
\end{figure}

Velmi roz¹íøenou metodou je nelineární metoda Dual quaternion skinning \cite{dualQuat}, kde se místo matic míchají duální kvaterniony. Tato metoda øe¹í artefakty vznikající u linear blend skinning, zachovává objem modelu a je velmi rychlá. Pou¾ívá se v roz¹írených modelovacích programech jako je napø. Blender. Klasické kvaterniony umo¾òují reprezentovat 3D rotaci okolo osy. Tato osa ale musí procházet poèátkem souøadného systému. Oproti tomu duální kvaterniony toto omezení nemají - osa mù¾e být libovolná. Kromì toho duální kvaterniony umo¾òují popsat posunutí. Ale neumo¾òují popsat zmìnu mìøítka. Proto nemù¾e docházet ke ztrátì objemu, jako u matic, kde násobením mù¾e vznikat zmen¹ení. Duální kvaterniony jsou také výhodné pro GPU hardware, proto¾e obsahují ménì hodnot ne¾ matice.

Pøiøazení vah je mo¾né automaticky metodou obálek \cite{envelopes}. Tato metoda je zalo¾ena na blízkosti kostí a jejich geometrie. Ka¾dá kost má dvì oblasti vlivu. Vnitøní oblast, kde je geometrie plnì ovlivnìna touto kostí. A vnìj¹í oblast, kde je geometrie ménì ovlivnìna kostí, èím blí¾e je k okraji této oblasti. 
Pokud chceme mít váhy urèené kvalitnì, je nutné nastavit váhy ruènì. To je mo¾né v nìkterém modelovacím programu, napøíklad Blender poskytuje "Weight Paint" mód, kde se pohybem ¹tìtce po modelu urèují váhy vrcholù pro jednotlivé kosti. Tento proces je iterativní a nároèný. Kreslením se odebírají nebo pøidávají váhy vrcholùm pro jednu aktivní kost. Poté se zkou¹í efekt na známé póze, upravují a vyhlazují váhy a tento proces se opakuje, dokud výsledek není dostateènì pøirozený. 
\begin{figure}[h]
\begin{center}
\subfloat{{\includegraphics[width=3cm]{fig/envelopes.png}}}
\qquad
\subfloat{{\includegraphics[width=7cm]{fig/weight_paint.png}}}
\caption{Metoda obálek v programu Blender (pøevzato z \cite{envelopes}) a model ve Weight paint módu v Blenderu.} \label{envelope_weight_paint}
\end{center}
\end{figure}

\section{Tvorba animace}
Animace èlovìka se vyskytuje ve velkém mno¾ství aplikací v rùzných prostøedích a podmínkách. Tyto animace by proto mìly být pøizpùsobitelné prostøedí v reálném èase. Také by mìly pùsobit pøirozenì a tím pøidávat na reálnosti.

Základní nástroje pro specifikaci pohybu jsou zalo¾eny na kinematikách. Existují dva zpùsoby popisu kinematické informace: inverzní a pøímá kinematika, viz kapitola \ref{kinematics}. 

Welbergen a spol. \cite{survey} dìlí techniky tvorby animace do tøí skupin: procedurální simulace, fyzikální simulace a editace pohybu.

Techniky se také mohou kombinovat dohromady a vyu¾ívat vhodnìj¹í techniku pro danou situaci nebo èást tìla. Mù¾e se napøíklad pou¾ít technika editace pohybu dokud nedojde k interakci s prostøedím a ta se mù¾e zpracovat pomocí fyzikální simulace. Nebo pomocí procedurální simulace vytvoøit gesta rukou a fyzikální simulací zachovat fyzikálnì pøirozené balancování spodní èásti tìla.

\subsection{Procedurální simulace}
Procedurální simulace popisuje animaci algoritmicky pomocí matematických formulí. Její úspìch závisí na tom, jak hluboce jsme schopni pochopit a modelovat simulovaný pohyb. Umo¾òují pøesné èasování a pozicování kostí. Metody mohou popisovat rotace kostí pøímo nebo popisovat cesty koncových uzlù kostry (chodidla), potom se pou¾ívá inverzní kinematika. 

Procedurální simulace umo¾òuje pøesné èasování a pozicování konèetin a mù¾e vyu¾ívat velké mno¾ství parametrù, pomocí kterých je mo¾né upravit výstup na míru po¾adavkùm. Dobøe se adaptují na prostøedí a jsou málo výpoèetnì nároèné. Nicménì je èasto problematické zakomponovat detaily jako jsou u editace pohybu do matematických formulí. Také je nutné explicitnì zachovávat fyzikální pøirozenost v procedurálním modelu pohybu pro v¹echny mo¾nosti parametrù. Je èasto pou¾ívána pro animaci gest a mluvení, které vy¾adují velké mno¾ství parametrù.

\subsection{Fyzikální simulace}
V mnoha pøípadech je vhodné poèítat s dynamikami \cite{surveyWalk}, aby byla zachována realistiènost pohybu. Tyto pøípady mohou být:
\begin{itemize}
\item jestli¾e postava nese náklad
\item jestli¾e postava musí reagovat na externí síly jako poryvy vìtru
\item  povrch na kterém se pohybuje je komplexní (schody atp.)
\end{itemize}

Dynamiky se pou¾ívají u technik ze skupiny fyzikální simulace. Dynamiky jsou zalo¾ené na Newtonových pohybových zákonech. Spojují síly (resp. toèivé momenty rotací) do výsledného pohybu (resp. rotace) podle rovnice: 
\begin{eqnarray}
f=m \cdot \ddot{x}\label{r.dynamics1}
\end{eqnarray}
kde $f$ je síla aplikovaná na objekt, $m$ je jeho hmotnost, $\ddot{x}$ je druhá derivace $x$ podle èasu. Pro rotace vypadají rovnice podobnì. Toèivé momenty a úhlové pozice jsou spojeny pomocí:
\begin{eqnarray}
t=i \cdot \ddot{\theta} + \dot{\theta} \times i \cdot \ddot{\theta}\label{r.dynamics2}
\end{eqnarray} 
kde $t$ je toèivý moment, $i$ je matice setrvaènosti, $\dot{\theta}$ je úhlová rychlost a $\ddot{\theta}$ je úhlové zrychlení. Pøímá dynamika je aplikace tìchto zákonù k výpoètu pohybu vygenerovaného danou silou. Inverzní dynamika se zabývá urèováním síly, která by vygenerovala daný pohyb.

Ve fyzikální simulaci je model typicky reprezentovaný jako systém pevných tìles propojených klouby. Ka¾dé z tìchto pevných tìles má pøiøazené fyzikální vlastnosti jako napø. hmotnost. Pohyb je generován manipulací s toèivými momenty kloubù s pou¾itím pøímé dynamiky. Pro umo¾nìní kolizí je nutné geometricky reprezentovat pevná tìlesa. Pou¾ití samotného povrchového modelu je pøíli¹ výpoèetnì nároèné, proto se pou¾ívají pro kolize aproximace pomoci základních tvarù, napø. válec.

Metody mohou fungovat na základì zadávání geometrických omezení jako parametrù animace. Tato omezení mohou být typicky splnìna velkým mno¾stvím rùzných toèivých momentù. Proto se mohou zavést objektivní funkce pro preferenci jistých øe¹ení. Tyto metody jsou pro animace v reálném èase velmi pomalé. Jiný zpùsob je pou¾ívání kontrolérù, do kterých vstupuje ¾ádaný stav systému. Výstupem je mno¾ina toèivých momentù kloubù, které po aplikaci na systém vedou promìnné k jejich po¾adovaným hodnotám. Kontrolér vyu¾ívá fyzikálních vlastností pohybujícího se tìla. Úlohou kontroléru je minimalizace nesrovnalostí mezi aktuálním a po¾adovaným stavem. Síly a toèivé momenty urèené kontrolérem, gravitace a síly zpùsobené externími vlivy jsou aplikované na fyzické tìlo. To je poté pohnuto pomocí pøímé dynamiky. 

Fyzikální simulace poskytuje fyzikálnì realistický pohyb a interakci s prostøedím. Umo¾òuje zachování parametrù pod vlivem externích sil. Nicménì pøesné èasování a umis»ování konèetin je problematické. Aèkoliv fyzikální simulace poskytuje fyzikálnì správný pohyb, není èasto dostaèující pro vytvoøení pøirozeného pohybu. 

\subsection{Editace pohybu}
Metody editace pohybu vytváøí pohyb na základnì vzorù pohybu. Metody modifikace pohybu generují nová pohybová primitiva modifikací jednoho vzoru pohybu. Kombinaèní techniky vytváøí pohybová primitiva pomocí databáze vìt¹ího mno¾ství vzorových primitiv. Pohyby se mohou vytváøet pomocí technik ze zpracování signálù, interpolací mezi vzory pohybù nebo pomocí statistických modelù. 

Techniky editace pohybu zachovávají pøirozenost vstupních vzorù pohybu, ale pouze jsou-li zmìny malé. Pøirozenost i pøi vìt¹ích zmìnách je zachována technikami pou¾ívající více vzorù na jeden pohyb. Nicménì pro v¹echny techniky roste poèet vzorù  exponenciálnì s poètem parametrù animace. Navíc techniky editace pohybu neposkytují fyzikální interakci s prostøedím, ale jsou vázány na specifický kontext. Jsou vhodné pro vytváøení animací v pøedstihu pro neinteraktivní aplikace, napø. filmy. Pro interaktivní (napø. videohry) je potøeba velká databáze pohybù. Pohyby se mohou vytváøet pomocí technik ze zpracování signálù, interpolací mezi vzory pohybù nebo pomocí statistických modelù.

Vstupní data mohou být být tvoøená animátorem ruènì, ale mohou být získána i napø. pomocí motion capture. Motion capture  \cite{motion_capture} jsou techniky pro nahrávání pohybù èlovìka, zvíøete nebo jiného subjektu. Mají velké vyu¾ití ve filmech a videohrách. Nejèastìji se pou¾ívá optických metod pro zachycení pohybu. V Motion capture má herec okolo ka¾dého kloubu znaèky, které jsou zaznamenávány a sledovány kamerami. Výstupem je mno¾ina lokací bodù v èase. Tìmi se poté prolo¾í kostra.
\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/motion_capture.jpg}}
\caption{Automatická rekonstukce kostry podle pozic znaèek. Pøevzato z \cite{motion_capture}.} \label{motion_capture_img}
\end{center}
\end{figure}

\chapter{Kinematiky} 
\label{kinematics}
Kinematiky v poèítaèové grafice slou¾í pro manipulaci s kostrou. Jsou  rozdìleny na dvì èásti: pøímá a inverzní kinematika. V pøímé kinematice se hýbe s ka¾dou kostí v øetìzci kostí a podle toho se urèí výsledná pozice posledního èlánku - koncového efektoru. Výsledky pøi ruèním vytváøení animace jsou velmi závislé na schopnostech animátora, proto¾e musí nastavovat pozice kostí od ruky. V této technice je obtí¾né omezovat pohyb, napøíklad ¾e chodidlo nemù¾e proniknout do zemì. 

Máme-li øetìzec kloubù, kde ka¾dý kloub $i$ má pøiøazen úhel $\theta_i$, který urèuje jeho rotaci oproti jeho pøedkovi, viz obrázek \ref{ik_chain}. Potom stav øetìzce je urèen stavovým vektorem $\boldsymbol{\theta}(\theta_1,\dots,\theta_n)$. Oznaème pozici koncového efektoru $\mathbf{P}$. Pøímá kinematika øe¹í následující rovnici:
\begin{eqnarray}
\mathbf{P} = f(\boldsymbol{\theta})\label{r.forward_kinematics}
\end{eqnarray}
Ka¾dý kloub mù¾e mít více ne¾ jeden stupeò volnosti, tedy být definován více úhly. Tím je urèena slo¾itost struktury kloubù, která je definována jako souèet stupòù volnosti v¹ech prvkù.

Oproti tomu v inverzní kinematice \cite{Buss09introductionto}\cite{welman} se hýbe pouze s koncovým efektorem a pohyb ostatních kloubù se dopoèítá, tak aby byl tento pohyb umo¾nìn. To je matematicky zapsáno následovnì:
\begin{eqnarray}
\boldsymbol{\theta} = f^{-1}(\mathbf{P})\label{r.inverse_kinematics}
\end{eqnarray}

\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/ik_chain.eps}}
\caption{Pøíklad øetìzce tøí kloubù.} \label{ik_chain}
\end{center}
\end{figure}
Øe¹ení inverzní kinematiky není tak jednoduché jako pøímé. Funkce $f$ je nelineární a aèkoliv v rovnici \ref{r.forward_kinematics} existuje unikátní namapování z $\boldsymbol{\theta}$ na $\mathbf{P}$, pro inverzní mapování v rovnici \ref{r.inverse_kinematics} mù¾e být nekoneèné mno¾ství $\boldsymbol{\theta}$ pro jedno konkrétní $\mathbf{P}$. Analytické øe¹ení pro libovolný øetìzec kloubù neexistuje. Problém ze øe¹í pomocí numerických metod pro øe¹ení systémù nelineárních rovnic. Z nekoneèného mno¾ství øe¹ení je snaha vybírat to nejvhodnìj¹í øe¹ení. Rùzné metody preferují rùzné øe¹ení a proto se metody, které se pro øe¹ení pou¾ijí vybírají na základì konkrétnì øe¹eného problému. V pøípadì lidské kostry má ka¾dý kloub urèené stupnì volnosti, aby rotovali jenom v urèitých smìrech a také je definován maximální úhel rotace. Napøíklad koleno rotuje pouze v jednom smìru a nemù¾e být otevøeno více ne¾ 180° a zavøeno ménì ne¾ cca 30°. Inverzní kinematika poskytuje lep¹í kontrolu nad koncovým efektorem, jeho¾ cílová pozice nás vìt¹inou nejvíce zajímá. V modelovacím programu mù¾eme hýbat napø. pouze chodidlem a nemusíme také pohybovat stehenní a lýtkovou kostí. Toho se také vyu¾ije v procedurální animaci lidské chùze, kde budeme urèovat trajektorie koncových efektorù. Techniky zalo¾ené na kinematikách vyu¾ívají empirickou a biomechanickou znalost pohybu pro generování animace. 

Nyní si uká¾eme nìkteré zpùsoby øe¹ení inverzní kinematiky.
\section{Jacobiho inverzní metoda}
Jacobiho inverzní metoda \cite{Buss09introductionto}\cite{welman}\cite{AristidouTR632} je iterativní metoda vyu¾ívající Jacobiho matice k aproximaci øe¹ení. Vztah mezi kartézským prostorem koncového efektoru $\mathbf{P}$ a prostoru kloubù úhlù $\boldsymbol{\theta}$ je:
\begin{eqnarray}
\mathbf{\dot{P}} = J(\boldsymbol{\theta})\boldsymbol{\dot{\theta}}\label{r.jacobian_vztah}
\end{eqnarray}
kde teèka znaèí první derivaci podle èasu. Jacobiho matice $J$ je $m \times n$ matice:
\begin{eqnarray}
J(\boldsymbol{\theta}) = \bigg(\frac{\partial P_i}{\partial \theta_j}\bigg)_{i,j}\label{r.jacobian_matrix}
\end{eqnarray}
kde $m$ je poèet dimenzí pozice koncového efektoru $\mathbf{P}$, $n$ je poèet dimenzí $\boldsymbol{\theta}$, $i = 1,\dots,m$ a $j = 1,\dots,n$. $J$ je matice èásteèných derivací celého øetìzce relativnì ke koncovému efektoru. $J$ mapuje zmìny promìnných kloubù $\boldsymbol{\theta}$ na zmìny v pozici koncového efektoru. Sloupec $i$ v $J$ reprezentuje inkrementální zmìnu pozice koncového efektoru zpùsobenou inkrementální zmìnou promìnné $\theta_i$. 
Neznámou pro inverzní kinematiku je $\boldsymbol{\dot{\theta}}$, proto potøebujeme inverzi Jacobiho matice. Vztah je následující:
\begin{eqnarray}
\boldsymbol{\dot{\theta}} = J^{-1}(\boldsymbol{\theta})\mathbf{\dot{P}}\label{r.jacobian_vztah_inverse}
\end{eqnarray}
Poté co urèíme Jacobiho matici, hledáme hodnotu $\Delta\boldsymbol{\theta}$ pro inkrementaci $\boldsymbol{\theta}$:
\begin{eqnarray}
\boldsymbol{\theta} = \boldsymbol{\theta} + \Delta\boldsymbol{\theta}\label{r.jacobian_increment}
\end{eqnarray}
Zmìna v pozici koncového efektoru urèená touto zmìnou je:
\begin{eqnarray}
\Delta\vec{\mathbf{s}} \thickapprox J\Delta\boldsymbol{\theta}\label{r.jacobian_change}
\end{eqnarray}
Hodnota $\Delta\boldsymbol{\theta}$ by mìla být vybrána tak, aby $\Delta\vec{\mathbf{s}}$ pøibli¾nì odpovídala $\vec{\mathbf{e}}$ - rozdílu mezí cílovou a aktuální pozicí koncového efektoru. Potom pøímá kinematika mù¾e být pøepsána jako $\vec{\mathbf{e}} = J\Delta\boldsymbol{\theta}$ a inverzní jako $\Delta\boldsymbol{\theta} = J^{-1}\vec{\mathbf{e}}$.

Jacobiho matice ale není v¾dy invertibilní, tzn. není ètvercová a zároveò singulární. To nastane kdy¾ konfigurace kloubù je redundantní nebo kdy¾ prochází skrz nebo blízko singulární konfigurace.

Øetìzec kloubù je redundantní jestli¾e obsahuje více stupòù volnosti, ne¾ je potøeba pro specifikaci cíle koncového efektoru. Je-li cíl koncového efektoru urèen pozicí v 3D prostoru, potom jakýkoliv øetìzec obsahující více ne¾ 3 stupnì volnosti je redundantní a tedy existuje nekoneènì mnoho øe¹ení. Jacobiho matice potom má více sloupcù ne¾ øádkù. V takových pøípadech se $J^{-1}$ nahradí generalizovanou inverzí $J^{\dagger}$, vet¹inou Moore-Penroseovou pseudoinverzí. Jestli¾e existuje nekoneèné mno¾ství øe¹ení, je mo¾né toho vyu¾ít pro splnìní nìjakého sekundárního kriteria, napø. vyhnutí se pøeká¾kám. Matice je singulární jestli¾e dva nebo více øádkù jsou lineárnì závislé, pøíklad takové konfigurace je vidìt na obrázku \ref{singular}. Jacobiho matice pro takovou konfiguraci bude obsahovat nuly v prvním øádku a nemù¾e být invertována. V takovém pøípadì je mo¾né pou¾ít pseudoinverzní matici, která poskytne øe¹ení v singulární konfiguraci, nicménì v okolí singulární konfigurace bude nevhodnì oscilovat. 
\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/singular.eps}}
\caption{Singulární konfigurace øetìzce kloubù.} \label{singular}
\end{center}
\end{figure}
\section{Cyclic Coordinate Descent}
Cyclic Coordinate Descent (CCD) \cite{welman} je øe¹ení inverzní kinematiky zalo¾ené na iterativním heuristickém vyhledávání, které se sna¾í o minimalizaci rotaèní chyby  zpracováváním jednoho kloubu v jeden okam¾ik. Ka¾dá iterace provede jednotlivì pohyb v¹ech èlánkù od nejposlednìj¹ího k prvnímu. To se opakuje dokud se nedosáhne po¾adované pozice koncového efektoru a nebo dokud se nepøesáhne maximální poèet cyklù. K urèení úhlu rotace se pou¾ívají dva vektory. Proto¾e metoda pracuje s jedním kloubem v jeden okam¾ik, zvýhodòuje klouby na zaèátku. Oproti metodám pou¾ívající Jacobiho matice provádí více iterací. Aèkoliv je algoritmus jednoduchý, je èasto nutné ho dále pøizpùsobovat, aby bylo dosa¾eno vhodných výsledkù.

Mìjme iteraci $i$ (viz obrázek \ref{ccd_img}) a pozici kloubu $\mathbf{k}_i$ pro $i$-tý kloub od konce øetìzce. Potom vektor $\mathbf{P}_{ia}$ je vektor od pozice kloubu $\mathbf{k}_i$ k aktuální pozici koncového efektoru a $\mathbf{P}_{ip}$ je vektor od $\mathbf{k}_i$ do po¾adované pozice koncového efektoru. Budeme-li rotovat vektor $\mathbf{P}_{ia}$ o úhel $\phi$, dostaneme nový vektor $\mathbf{P}'_{ia}(\phi)$. Jestli¾e úhel bude nabývat libovolných hodnot, $\mathbf{P}'_{ia}(\phi)$ zaène tvoøit kruh se støedem $\mathbf{k}_i$. Bod na tomto kruhu nejblí¾e k po¾adované pozici $\mathbf{P}_p$, je bod, na kterém kruh protíná pøímku urèenou vektorem $\mathbf{P}_{ip}$. Proto budeme mìnit rotaci kloubu $\mathbf{k}_i$ tak, aby se $\mathbf{P}_{ip}$ a $\mathbf{P}'_{ia}(\phi)$ zarovnaly.
\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/ccd.eps}}
\caption{Ukázka jedné iterace metody CCD.} \label{ccd_img}
\end{center}
\end{figure}
Úhel $\phi$ který hledáme, je úhel, který maximalizuje následující funkci:
\begin{eqnarray}
g(\phi) &=& k_1(1 - \cos\phi) + k_2 \cos\phi + k_3 \sin\phi\label{r.ccd_max1}
\end{eqnarray}
kde $k_1$, $k_2$ a $k_3$ jsou konstantní koeficienty, pro detaily viz \cite{welman}. Funkce má maximum v intervalu $-\pi \leq \phi \leq \pi$, kdy¾ je první derivace nula a druhá derivace je záporná. Z první podmínky dostáváme rovnici:
\begin{eqnarray}
\phi &=& \tan^{-1}\frac{k_3}{k_2 - k_1}\label{r.ccd_max2}
\end{eqnarray}
která vymezí kandidátní hodnotu $\phi_c$ v rozsahu $\frac{-\pi}{2} \leq \phi_c \leq \frac{\pi}{2}$. Proto¾e $\tan$ je periodické, musíme uva¾ovat i dvì dal¹í kandidátní hodnoty: $\phi_c + \pi$ a $\phi_c - \pi$. Z kandidátních hodnot se vybere taková, která spadá do intervalu $-\pi \leq x \leq \pi$ a její¾ druhá derivace je záporná. Je-li jich více, funkce se vyhodnotí nad v¹emi a vybere se z nich maximum. Poté co jsme získali úhel $\phi$, mù¾eme ho vynásobit váhou urèující tuhost kloubu a pøièíst ho k aktuální rotaci $r_i$ kloubu $i$. Poté se pokraèuje s iterací $i+1$.
\chapter{Lidská chùze}
Lidská chùze \cite{gait_review} se skládá z opakujících se krokových cyklù neboli dvojkrokù, viz obrázek \ref{gait_cycle}. Cyklus je sekvence pohybù od doby kdy se jedna noha dotkne zemì do doby kdy se stejná noha dotkne zemì znovu. Ka¾dý krokový cyklus má dvì základní fáze: stojnou fázi a ¹vihovou fázi. Proto¾e je cyklus shodný pro obì nohy, budeme popisovat pouze jednu.

Stojná fáze, je fáze, kdy je noha v kontaktu se zemí. Zabírá 60\% dvojkroku a zaèíná s úderem paty (poèáteèní kontakt) a konèí s odrazem palce. Je dále rozdìlena do podfází:
\begin{itemize}
\item stadium zatì¾ování
\item mezistoj
\item koneèný stoj
\item pøed¹vihová fáze
\end{itemize}
Po poèáteèním kontaktu pravé nohy nastává perioda dvojí opory, která konèí pøi odrazu palce levé nohy. Následuje jedno-oporová fáze do té doby, ne¾ se levá dostane do poèáteèního kontaktu. Nastává druhá perioda dvojí opory, a¾ do odrazu palce pravé nohy. V ka¾dé fázi dvojí opory je jedna noha vpøedu, právì se dotkla zemì. A druhá je vzadu pøipravena na zvednutí se ze zemì. Pøední noha je ve stadiu zatì¾ování  a zadní je v koneèném ¹vihu. V ka¾dém krokovém cyklu jsou dvì periody dvojí opory a dvì periody jedno-oporové fáze. Dvojí opora zabírá pøibli¾nì 10\% dvojkroku, ale její délka se mìní s rychlostí chùze. S vìt¹í rychlostí se prodlu¾uje ¹vihová fáze a zkracuje fáze dvojí opory. Kdy¾ dvojí opora úplnì vymizí z chùze se stává bìh. Mezi kroky bìhu je fáze letu, kdy není ¾ádná noha na zemi.

©vihová fáze nastává kdy¾ je chodidlo ve vzduchu a trvá 40\% délky dvojkroku. Zaèíná s úderem paty a konèí s druhým odrazem palce.  Je dále rozdìlena do podfází:
\begin{itemize}
\item poèáteèní ¹vih
\item mezi¹vih
\item koneèný ¹vih
\end{itemize}

\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/gait-cycle.jpg}}
\caption{Krokový cyklus a jeho fáze. Pøevzato z \cite{gait_img}.} \label{gait_cycle}
\end{center}
\end{figure}

Nyní si popí¹eme nìkteré termíny a parametry specifikující chùzi. Délka dvojkroku je vzdálenost mezi dvìma po sobì jdoucími kroky stejné nohy. Skládá se ze dvou délek kroku, levé a pravé, ka¾dá s nich urèuje vzdálenost o kterou se jedna noha pøesune pøed druhou. Mù¾e být napø. nulová, kdy¾ se levá noha pøesune na úroveò pravé a ne pøed ní. ©íøka dvojkroku je vzdálenost mezi pøímkami urèenými støedy pat obou nohou pøi chùzi. Úhel vytoèení chodidla urèuje úhel mezi zmínìnou pøímkou a pøímkou procházející støedem chodidla. Kadence je poèet krokù v daném èase. V jednom krokovém cyklu jsou dva kroky a tedy kadence je mìøítko  pùl-cyklù. Èas dvojkroku $c$ v sekundách se urèí jako $c = 120/kad$, kde $kad$ je kadence v krocích za minutu. Rychlost chùze je vzdálenost u¹lá v èase. Okam¾itá rychlost je variabilní v prùbìhu kroku, ale prùmìrná rychlost je výsledkem kadence a délky dvojkroku. Rychlost chùze $r$ se spoèítá jako $r = d/c$, kde $d$ je délka dvojkroku. Rychlost chùze tedy závisí na délce kroku, které závisí na délce ¹vihové fáze.

\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/step_length.png}}
\caption{Délka, ¹íøka kroku a úhel vytoèení chodidla. Pøevzato z \cite{gait_review}.} \label{step_length}
\end{center}
\end{figure}

\section{Fáze krokového cyklu}
Následuje podrobnìj¹í popis jednotlivých fází krokového cyklu \cite{gait_review}. 
\subsection{Poèáteèní kontakt}
V této fázi je kyèel ohnutá, koleno nata¾ené a kotník v neutrální poloze. Kontakt se zemí je dosa¾en pomocí paty, která se stává støedem otáèení. Druhá noha je na konci koneèného stoje. Tato fáze obsahuje moment kdy právì nastane dotyk nohy se zemí. Dr¾ení tìla v tuto chvíli urèuje pohyb konèetiny ve stadiu zatì¾ování. 
\subsection{Stadium zatì¾ování}
Stadium zatì¾ování je fáze, kde je váha tìla pøenesena na pøední nohu. Koleno je pokrèeno pro absorbci ¹oku. Chodidlo se dostává do plného kontaktu se zemí. Protilehlá noha je v pøed¹vihové fázi. Tato fáze je poèátkem fáze dvojí opory. Pokraèuje dokud nezaène být druhá noha zvedána ke ¹vihu. 
\subsection{Mezistoj}
V mezistoji dochází k posunutí dolní konèetiny pøes zafixované chodidlo, zatímco koleno a kotník se propínají. Protilehlá noha se nachází uprostøed mezi¹vihové fáze. Je to první polovina intervalu stoje na pouze jedné noze. Trvá od zvednutí druhé nohy dokud váha není pøesunuta po chodidle do oblasti pøedno¾í. 
\subsection{Koneèný stoj}
Bìhem druhé poloviny intervalu stoje na jedné noze se zvedne pata a støed otáèení stojné konèetiny se pøesune do pøední èásti nohy. Koleno zvý¹í své propnutí a poté se zaène lehce ohýbat, kyèel se propíná. Druhá noha je v koneèném ¹vihu. Zaèíná se zdvihem paty a konèí v okam¾iku kontaktu paty druhé nohy se zemí. Váha tìla je pøesunuta pøed nohu. 
\subsection{Pøed¹vihová fáze}
Kontakt se zemí druhé nohy zaèal dal¹í fázi dvojí opory. Referenèní noha zvý¹í ohyb v kotníku a v koleni, kyèel ji¾ není propnutá. Protilehlá noha je ve stadiu zatì¾ování. Tato poslední podfáze stojné fáze je druhým (a posledním) intervalem dvojí opory v krokovém cyklu. Zaèíná s poèáteèním kontaktem druhé nohy a konèí s odrazem palce referenèní nohy. Váha je uvolnìna z referenèní nohy a pøenesena na nohu druhou. Uvolnìná noha vyu¾ije volnosti k pøípravì na ¹vihovou fázi, k èemu¾ slou¾í v¹echny pohyby a svalové akce odehrávající se v tuto dobu.
\subsection{Poèáteèní ¹vih}
Chodidlo je zvednuto a pøesunuto vpøed pomocí ohybu v kyèli a koleni. Kotník èásteènì dorziflexuje (ohyb kotníku smìrem k høbetu nohy). Druhá konèetina je na zaèátku mezi¹vihu. Tato fáze je pøibli¾nì tøetina ¹vihové periody. Zaèíná kdy¾ noha opustí podlo¾ku a konèí v okam¾iku maximálního propnutí v koleni.
\subsection{Mezi¹vih}
Pøesun nohy dopøedu je získán dal¹ím ohybem v kyèli. Koleno se propíná  a kotník dorziflexuje do neutrální polohy. Druhá noha je na konci mezistoje. Tato druhá fáze ¹vihové periody zaèíná kdy¾ je ¹vihová noha  naproti stojné noze. Konèí kdy¾ je holení kost ve vertikálním postavení - ohyb kolene a kyèle je shodný.
\subsection{Koneèný ¹vih}
Pøesun chodidla je ukonèen propnutím kolene a pøesunem holenì pøed stehno. Kyèel si zachovává ohyb z pøedchozí fáze. Kotník zùstává v neutrální poloze. Druhá noha je v koneèném stoji. Tato poslední fáze ¹vihu zaèíná s vertikální holení kostí a konèí pøi kontaktu nohy se zemí. Touto fází je pøesun nohy ukonèen.
\section{Interactive Animation of Personalized Human Locomotion}
V èlánku Interactive Animation of Personalized Human Locomotion \cite{bruderlin} je popsán systém pro tvorbu lidského pohybu pomocí procedurální animace. Umo¾òuje specifikaci tøí parametrù: délka kroku, kadence krokù a rychlost. A 15 atributù jako je napø. rotace a náklon pánve. Díky tìmto atributùm je umo¾nìna individualizace pohybu pro starého èlovìka, malé dítì apod. Tento systém je plnì kinematický. 

Pro ka¾dý krok jsou vypoèítány tøi omezení ze specifikovaných parametrù a atributù: doba trvání fází kroku (stojná a ¹vihová), úhly nohy na konci kroku a kontrolní body urèující pohyb kyèle stojné nohy bìhem kroku. Urèují se ètyøi kontrolní body zvlá¹» pro vertikální a horizontální komponent. První a  poslední bod se urèí z délky kroku a úhlù nohy na zaèátku a konci kroku. Druhý a tøetí kontrolní bod se urèí na základì znalosti, ¾e vertikální pøesun je nejni¾¹í uprostøed dvojí opory a nejvy¹¹í uprostøed ¹vihové fáze. Zatímco horizontální pøesun má maximum a minimum opaènì. To je v korelaci s výdajem energie bìhen jednoho dvojkroku, jak je vidìt na obrázku \ref{bruderlin_img}, kde potenciální energie je identická s vertikálním pøesunem a kinetická s horizontálním. Mezi body z ka¾dé mno¾iny jsou prolo¾eny interpolaèní spline køivky a tím je urèen pohyb kyèle pro stojnou nohu bìhem kroku. Pozice prstù nohy je statická bìhem stojné fáze. Úhly zbylých kloubù nohy jsou dopoèítány pomocí inverzní kinematiky.

\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/bruderlin.png}}
\caption{Aproximace kinetických a potenciálních energií horní poloviny tìla pro prùmìrný krok. Pøevzato z \cite{bruderlin}.} \label{bruderlin_img}
\end{center}
\end{figure}

Tím je urèen pohyb stojné nohy. Dále se urèí rotace, úklon a náklon pánve. Rotace pánve je na maximu pøi úderu paty na zem a na minimu v mezistoji. Úklon pánve má minimum pøi úderu paty a maximum na konci dvojí opory. Náklon pánve je zpùsobem tím, ¾e se tìlo v¾dy nakloní na stranu nohy nesoucí váhu. Je minimální pøi úderu paty a maximální uprostøed stojné fáze. Pozice kyèle nohy ve ¹vihu je urèena interpolací tìchto hodnot. Pohyb nohy ve ¹vihu je rozdìlen do tøí fází a urèen lineární interpolací. Pohyb horní poloviny tìla je urèen v závislosti na spodní, napø. ruka se hýbe dopøedu s protilehlou nohou. Pohyb ruky a rotace ramene je urèen nastavitelnými atributy.

\section{Animation of Human Walking in Virtual Environments}
Kontrolní systém pro animaci lidské chùze po nerovném terénu je prezentován v èlánku Animation of Human Walking in Virtual Environments \cite{chung}. Pou¾ívá se model èlovìka s 18 klouby a celkem 36 stupni volnosti. 

Kontrola pohybu na nejvy¹¹í úrovni umo¾òuje u¾ivateli animovat pohyby s malým mno¾stvím parametrù. U¾ivatel specifikuje cestu pohybu pomocí kubických splinù v horizontální rovinì. Z parametrù vý¹ky èlovìka a rychlosti chùze je vygenerována délka a frekvence kroku. Pro normální chùzi mù¾e být vztah urèen jako v rovnici:
\begin{eqnarray}
l &=& \sqrt{0.004 \times s \times h}\label{r.step_length}
\end{eqnarray}
kde $l$ je délka kroku, $s$ je rychlost trupu a $h$ je vý¹ka èlovìka.
Výpoèet pozice chodidla na terénu je urèen jako funkce délky kroku, zmìny smìru globální cesty a stavu terénu. Prvnì jsou pozice chodidel rovnomìrnì rozlo¾eny po køivce cesty v horizontální rovinì. Pøesáhne-li rotace chodidla prahovou hodnotu, je krok zkrácen, ale doba provedení kroku zùstane zachována. Stav terénù ve 3D je zkontrolován pro urèení bezkolizních trajektorií nohou. 

Na støední úrovni kontroly jsou poskytnuty atributy pro kontrolu spodní èásti tìla. Prvnì se odhadnou úhly dopadu a zvednutí chodidla stojící nohy. Z tìchto odhadnutých hodnot a podle pøibli¾né trajektorie pánve jsou pomocí inverzí kinematiky dopoèítány úhly kolene a kyèle. Poté jsou pøesnì dopoèítány úhly dopadu a zvednutí chodidla. Trajektorie chodidla se urèí lineární interpolací mezi polo¾eným chodidlem na zemi a úhly dopadu a zvednutí chodidla. Tím je urèena trajektorie stojící nohy, jednoho z koncových efektorù pro øetìzec inverzní kinematiky. Nyní je potøeba urèit pohyb koøene øetìzce, pánve. 

Observace ukázaly, ¾e trajektorie pánve pøibli¾nì odpovídá sinusoidì, viz obrázek \ref{chung_pelvis}. Pro interpolaci jsou pou¾ity kubické spliny, konkrétnì Beziérova køivka. Pánev prochází vertikálním maximem uprostøed stojné fáze, tato hodnota se urèí podle velikosti ohybu kolene. Pánev prochází minimem uprostøed intervalu dvojí opory, kdy obì nohy jsou v kontaktu se zemí. Pozice v této fázi je urèena tak, aby byla minimalizována suma úhlových zrychlení v¹ech kloubù podpírající nohy. U¾ivatel mù¾e tìmto kloubùm nastavovat váhy. Výsledná Beziérova køivka je poté nerovnomìrnì vzorkována, aby bylo dosa¾eno nejrychlej¹ího pohybu bìhem dvojí opory a nejpomalej¹ího uprostøed stojné fáze. 
\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/chung_pelvis.png}}
\caption{3D trajektorie (c) je urèena z vertikálního (a) a horizontálního (b) posuvu. Pøevzato z \cite{chung}.} \label{chung_pelvis}
\end{center}
\end{figure}
Pro definici trajektorie chodidla nohy ve ¹vihové fázi se pou¾ijí Beziérovy køivky obdobnì jako pøi pohybu pánve. Spolu se znalostí pozice koøene (pánve) kinematického øetìzce se dopoèítají pozice ostatních kloubù. Trajektorie se urèí tak, aby se chodidlo vyhnulo kolizím a aby byla spotøebována co nejmen¹í energie. Na nejni¾¹í úrovni je poté mo¾né nastavit dal¹í atributy, napø. rotace a náklon pánve.

\chapter{Návrh a realizace øe¹ení}
Øe¹ení je implementováno v jazyce C++. 3D grafika je vykreslena pomocí rozhraní OpenGL. OpenGL je multiplatformní rozhraní, podporováno mno¾stvím programovacích jazykù, umo¾òující vykreslování 2D a 3D grafiky. Komunikuje s grafickým procesorem pro hardwarovì akcelerované vykreslování. Pro zpracování vstupù a vytvoøení kontextu OpenGL je vyu¾ita knihovna SDL 2.0. SDL je multiplatformní knihovna umo¾òující nízkoúrovòový pøístup ke klávesnici, my¹i, zvuku a grafickému hardwaru. Funguje nativnì v C++.

Aplikace umo¾òuje naètení pøedpøipraveného modelu s pøipojenou kostrou. Pøípadnì u¾ivatel mù¾e vyu¾ít poskytnutou pøedpøipravenou kostru a na ní si pøipojit vlastní model. A ten poté vyexportovat v Blenderu do formátu COLLADA (.dae). Aplikace model zobrazí za vyu¾ití Linear blend skinning (kapitola \ref{linear_blend_skinning}) algoritmu. U¾ivatel má mo¾nost zobrazení pouze kù¾e modelu, nebo kostry, nebo obojí zároveò. Model je animován. Je mo¾nost pomocí nìkolika parametrù upravit animaci chùze. K tomu slou¾í grafické u¾ivatelské rozhraní. Animace mù¾e být vyexportována a následnì pou¾ita napøíklad v Unity enginu.

\subsection{Naètení modelu}
Model je naèítán z formátu COLLADA, který podporuje ulo¾ení geometrie, efektù, fyziky, animace, kinematik scény aj. Vyu¾ívá XML schéma. Pøi naèítání uva¾ujeme, ¾e model do tohoto formátu byl exportován z Blenderu.

Zaène se naètením geometrie modelu z XML elementu  \texttt{library\_geometries}. Ulo¾í se pole s pozicemi vrcholù, normálami a texturovacími koordináty. Naètou se seznamy polygonù, které jsou urèeny odkazy do polí naètených v pøedchozím kroku. Oèekává se pou¾ití pouze trojúhelníkù. Tìchto seznamù mù¾e být více, li¹í se pou¾itým materiálem a v na¹í aplikaci jeden tento seznam tvoøí jeden  \texttt{Mesh} (kód \ref{weighted_mesh}). Název materiálu je nastavený v Blenderu a pøi naèítání modelu se oèekává pøilo¾ení textury se shodným názvem a pøíponou "\_D" pro difuzní texturu.

\begin{lstlisting}[language=C++, caption={Tøída modelu.}, label={weighted_mesh}]
class Mesh {
protected:
  std::vector<glm::vec3> v; //pozice vrcholu
  std::vector<glm::vec3> n; //normaly
  std::vector<glm::vec2> t; //texturovaci koordinaty
  std::shared_ptr<Material> m; //material
public:
  /* ... */ };
  
class WeightedMesh : public Mesh {
private:
  std::vector<glm::vec4> weights; //vahy prirazenych kosti
  std::vector<glm::ivec4> jointIndices; //prirazene kosti
public:
  /* ... */ };
\end{lstlisting}

Následuje naètení vah a pøiøazení kostí vrcholùm z XML elementu  \texttt{library\_controllers}. První se pøeète bind shape matice. Ta popisuje transformaci geometrie do správného souøadného systému pro pou¾ití s klouby. Poté je naèten seznam názvù kostí, seznam inverzních bind pose matic $\mathbf{B}_i$ (viz rovnice \ref{r.transform_mat}) pro ka¾dou kost a seznam vah vrcholù. Následuje seznam, který urèuje pro ka¾dý vrchol poèet kloubù, které ho ovlivòují a stejný poèet odkazù do seznamu kloubù a vah.

Nyní se naète samotná hierarchie kostry z XML elementu \texttt{library\_visual\_scenes}. První uzel obsahuje koøenovou transformaci, od které se odvíjí dal¹í transformace v¹ech kostí. Kosti jsou hierarchicky zanoøené, obsahují název a lokální transformaèní matici, viz kód \ref{collada_skeleton}. Kosti se ukládají do 2D pole, kde ka¾dá kost má ulo¾ený index nadøazeného uzlu, tedy rodièovské kosti. A $0 \dots n$ indexù na své potomky, viz obrázek kód \ref{class_skeleton}. Kostem se následnì pøidají inverzní bind pose matice vynásobené bind shape maticí, ta se dále neukládá. Pro správné zobrazení kostry je nutné urèit velikost kostí, ta se urèí jako rozdíl pozice dané kosti a jejího potomka. Pokud ale kost nemá ¾ádného potomka nemù¾eme zjistit její velikost. Proto uva¾ujeme polovièní velikost ne¾ je velikost rodièovské kosti. Dále jsme zavedli mo¾nost pøidat kost, která se pou¾ije pouze pro urèení velikosti a poté se odstraní, taková kost musí ve svém názvu obsahovat "empty".

\begin{lstlisting}[language=C++, caption={Tøída kostry.}, label={class_skeleton}
]
struct Bone {
  glm::mat4 localMat; //lokalni transformace
  glm::mat4 globalMat; //globalni transformace
  glm::mat4 inverseBindMatrix; //inverzni bind pose matice
  int parent; //odkaz na rodicovskou kost
  std::vector<int> childs; //odkaz na potomky
  std::string name; //nazev kosti
  float scale; //velikost kosti, slouzi pro zobrazeni kosti 
};

class Skeleton {
private:
  std::vector<Bone> bones; //pole kosti
  glm::mat4 rootTransform; //korenova transformacni matice
public:
  /* ... */ };
\end{lstlisting}

Nakonec jsou naplnìny objekty tøídy \texttt{WeightedMesh} (kód \ref{weighted_mesh}). Proto¾e z hardwarových dùvodù je vhodné mít pro ka¾dý vrchol kù¾e pøiøazeny pouze ètyøi kosti a jejich váhy, abychom mohly pou¾ít \texttt{vec4} ve vertex shaderu. Musí být nìkteré kosti zanedbány, pokud jich vrchol  pou¾ívá více. Ètyøi kosti jsou dostateèné a pokud je jich více, mají nìkteré velmi nízké váhy. Proto jsou pro ka¾dý vrchol v¹echny jeho kosti seøazeny sestupnì podle vah a ukládají se pouze první ètyøi. Váhy ostatních jsou rozlo¾eny rovnomìrnì mezi tyto ètyøi kosti, aby zùstala zachována podmínka o celkovém souètu v¹ech vah (viz \ref{weight_sum}).

\begin{lstlisting}[language=XML, caption={Ukázka ulo¾ení hierarchie kostry ve formátu COLLADA.}, label={collada_skeleton}]
<library_visual_scenes>
  <visual_scene id="Scene" name="Scene">
    <!-- ... -->
    <node id="metarig" name="metarig" type="NODE">
      <matrix sid="transform">1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1</matrix>
      <node id="hips" name="hips" sid="hips" type="JOINT">
        <matrix sid="transform">
          1 0 0 0 0 -0.16 -0.98 0.05 0 0.98 -0.167 1.01 0 0 0 1
        </matrix>
        <node id="spine" name="spine" sid="spine" type="JOINT">
          <matrix sid="transform">
            1 0 0 0 0 0.99 0.11 0.17 0 -0.11 0.99 1.49e-8 0 0 0 1
          </matrix>
          <node id="chest" name="chest" sid="chest" type="JOINT">
            <matrix sid="transform">
              1 0 0 0 0 0.99 0.14 0.15 0 -0.14 0.99 7.45e-9 0 0 0 1
            </matrix>
            <!-- ... -->
          </node>
        </node>
        <!-- ... -->
      </node>
    </node>
    <!-- ... -->
  </visual_scene>
</library_visual_scenes>
\end{lstlisting}

\subsection{Zobrazení}
Pøed ka¾dým zobrazením snímku je nutné spoèítat globální matice pro v¹echny kosti kostry. Proto procházíme pole s kostmi a pro ka¾dou kost vynásobíme globální matici rodièe s její lokální maticí. Poté získáme transformaèní matici $\mathbf{T}$ podle rovnice \ref{r.transform_mat}. Vezmeme koøenovou transformaèní matici a nastavíme jí jako model matici do vertex shaderu. Následnì ve vertex shaderu získáme pozici vrcholu násobením maticí $\mathbf{T}$ a odpovídající vahou pro ètyøi pøiøazené kosti. Pøepoèítáváme také normálu, viz kód \ref{animation_shader}.

\begin{lstlisting}[language=GLSL, caption={Ukázka z vertex shaderu pro animovaný model. Výpoèet pro pozici a normálu se provede \(4 \times \), pro komponenty \texttt{x}, \texttt{y}, \texttt{z} a \texttt{w} vektorù \texttt{v\_weights} a \texttt{v\_joints}.}, label={animation_shader}]
vec4 pos = vec4(0.0);
pos += T[v_joints.x] * vec4(v_pos, 1.0) * v_weights.x;
/* ... */
vec4 norm = vec4(0.0);
norm += transpose(inverse(T[v_joints.x])) * vec4(v_norm, 1.0) * v_weights.x;
/* ... */
gl_Position = mvp * vec4(pos.xyz, 1.0);
\end{lstlisting}

Následuje zobrazení kostry. Pro ka¾dou kost se pou¾ije shodný model. Pro kosti se pou¾ívají globální matice shodné jako pøi zobrazování kù¾e, ale je v nich zapoèítané zvìt¹ení, aby na sebe kosti navazovaly.  Výsledná model matice kosti je koøenová transformace vynásobená s touto globální maticí kosti. Pøed zobrazením je vyèi¹tìn hloubkový buffer, aby se kostra pøekreslila pøes model. 

Pro zobrazení jsou pou¾ity difuzní textury a Phongùv osvìtlovací model. Výsledný výstup viz obrázek \ref{graphical_output}.

\begin{figure}[h]
\begin{center}
\subfloat{{\includegraphics[width=5cm]{fig/rigged.png}}}
\qquad
\subfloat{{\includegraphics[width=7cm]{fig/joker.png}}}
\caption{Grafický výstup aplikace pro dva rùzné modely. Model vpravo má rotované nìkteré kosti (ruènì, uvnitø kódu).} \label{graphical_output}
\end{center}
\end{figure}


\chapter{Závìr}
Bylo implementováno naètení modelu èlovìka spolu s pøipojenou kostrou a jeho zobrazení. Výsledná aplikace má ... øádkù kódu. Byly popsány nìkteré existující implementace procedurální animace a metody øe¹ení inverzní kinematiky. V rámci dal¹ího vývoje bude potøeba implementovat systém tvorby animace a její vyexportování do souboru.


%=========================================================================
