%=========================================================================
% (c) Michal Bidlo, Bohuslav Køena, 2008

\chapter{Úvod}
Poèítaèová animace má velké vyu¾ití pro poèítaèové hry a filmy. Existuje mno¾ství zpùsobù tvorby a zobrazování animace s rùznými výhodami a nevýhodami. V této práci se zabýváme tvorbou animace lidské chùze - jedné z nejpou¾ívanìj¹ích a nejdùle¾itìj¹ích animací. Tato animace musí být co nejpøirozenìj¹í, proto¾e lidé jsou velmi vnímaví na správnost lidské chùze a snadno rozpoznají, kdy je animace nepøirozená.

Existují rùzné pøístupy k tvorbì animace lidské chùze. Tyto pøístupy se li¹í v kompromisu mezi pøirozeností, kontrolou nad animací a výpoèetním èasem. Populární zpùsob tvorby animace je \textit{motion capture}, kde se zachytává pohyb herce pomocí kamer. Aèkoliv tento zpùsob dosahuje velké pøirozenosti, je velmi drahý. \textit{Fyzikálnì zalo¾ená simulace} umo¾òuje velmi dobrou interakci s prostøedím, ale je velmi výpoèetnì nároèná. Tato práce se zabývá \textit{procedurální animací}. Pøi tomto zpùsobu se vyu¾ívá znalostí o \textit{cyklu lidské chùze}, který je studován ji¾ od starovìku. Procedurální systém umo¾òuje jednodu¹e vytvoøit animaci pomocí specifikace mno¾ství parametrù. Je výpoèetnì nenároèná a vhodná pro interakci s prostøedím, ale ne tak fyzikálnì pøesná jako fyzikálnì zalo¾ená simulace. Také není tak detailní jako v motion capture.  V této práci si klademe za cíl vytvoøení systému, který umo¾ní rychlou a jednoduchou tvorbu specifické animace lidské chùze i u¾ivatelùm bez animaèních znalostí a schopností, kterou budou moci pou¾it napø. v poèítaèové høe.

Druhá kapitola se zamìøuje na \textit{skeletální animaci}. Pøibli¾uje co je to \textit{kostra} a jak se na ní pøipojí \textit{kù¾e}. Dále obsahuje struèný pøehled metod tvorby animace. Tøetí kapitola se vìnuje \textit{kinematikám}. Definuje co je to \textit{inverzní kinematika} a popisuje nìkteré metody jejího øe¹ení. Ve ètvrté kapitole je podrobnì popsána lidská chùze a její fáze. Pátá kapitola obsahuje popis nìkterých existujících implementací procedurální animace vyu¾ívající tyto znalosti. Pátá kapitola nastiòuje výslednou aplikaci a její øe¹ení a popisuje implementované èásti v rámci semestrálního projektu.
\chapter{Skeletální animace}
\textit{Skeletální animace} je zpùsob animace, který vyu¾ívá dvì základní komponenty: model (nejèastìji polygonální) nazýván \textit{kù¾e} a \textit{kostru}, na kterou je kù¾e pøipojena. Jestli¾e se pohne kost, pohne se také pøipojená kù¾e. V klasické animaci, je vytvoøen model pro ka¾dý \textit{klíèový snímek} animace a tyto modely se postupnì zobrazují. Oproti tomu se skeletální animace skládá pouze z jednoho modelu a pøipojené kostry, pro kterou jsou ulo¾eny pozice kostí v klíèových snímcích napø. cyklu chùze. Ka¾dý tento snímek definuje pozici ka¾dé kosti v konkrétní èas. Díky tomu má mnohem ni¾¹í pamì»ovou nároènost. Také skeletální animace umo¾òuje vysokou interakci s prostøedím. Kost se mù¾e zarazit o pøeká¾ku apod. Skeletální animace také mohou být pou¾ité na více rùzných modelech. Nìkdy programy poskytují pøedpøipravenou kostru, okolo které se vytvoøí kù¾e. Skeletální animace má také své nevýhody. Pohyby kostí a pøipojených vrcholù spotøebovávají výpoèetní výkon. V animacích obecnì se musí øe¹it interpolace mezi dvìma klíèovými snímky, proto¾e zobrazení snímku mù¾e probìhnout v libovolný èas.
\section{Kostra}
Kostra je abstraktní model lidského, zvíøecího tìla nebo jiného objektu. Jedná se o stromovou strukturu (obr. \ref{bone_structure}). Uzly jsou nazývány \textit{kosti} nebo \textit{klouby}. Ke kostem jsou pøiøazeny vrcholy. Kosti mají stupnì volnosti, které urèují v jakém smìru a jak moc se mù¾ou rotovat. Pøipojování modelu na kostru se nazývá \textit{skinning}.

\begin{figure}[h]
\begin{center}
\scalebox{0.5}{\includegraphics{fig/skeleton_names.pdf}}
\caption{Pøíklad hierarchie kostry.} \label{bone_structure}
\end{center}
\end{figure}

Ka¾dá kost má lokální transformaci: posunutí, rotaci a zvìt¹ení. Tato transformace se mù¾e ulo¾it jako matice a urèuje transformaci vùèi rodièovské kosti, pokud existuje. Pro realistické modely èlovìka se vìt¹inou pou¾ívá pouze rotace. Výsledná globální transformace kosti se získá kombinací rodièovské globální transformace a vlastní lokální transformace. Globální transformace v¹ech kostí se vypoèítá procházením stromové struktury kostry a postupným násobením transformaèních matic od koøene k listùm. Pro koøenovou kost je lokální transformace její globální. 

Pøed pøipojením kù¾e na kostru se kostra nastaví do pozice nazývané \textit{bind pose} \cite{bindPose}. To je základní pozice kostry pøed jakýmkoliv pohybem. V tuto chvíli se na kostru pøipojí kù¾e. Následnì jsou urèeny a ulo¾eny bind pose matice $\mathbf{B}$ pro ka¾dou kost. Ty urèují jejich transformaci z poèátku souøadného systému kostry do bind pose. Matice $\mathbf{B}_a$ ka¾dé kosti urèuje její aktuální transformaci z poèátku souøadného systému kostry. Pøed prvním pohybem kostry jsou shodné s $\mathbf{B}$. Chceme-li zmìnit pózu kostry (matici $\mathbf{B}_a$ nìjaké kosti) a tím i pøipojené kù¾e, musí se vrcholy transformovat ze souøadného systému kù¾e do souøadného systému kostry. K tomu se pou¾ije \textit{inverzní bind pose matice} $\mathbf{B}_i$. Ta urèuje transformaci kosti potøebnou pro pøesun kosti z bind pose do poèátku souøadného systému. Tedy invertuje transformaci, která byla na kù¾i aplikována v bind pose. Matematický zápis transformace $\mathbf{T}$ (obr. \ref{transform_pose}) urèující novou pozici kosti je následující:
\begin{eqnarray}
\mathbf{T} &=& \mathbf{B}_i \mathbf{B}_a\label{r.transform_mat}
\end{eqnarray}
Poté se mù¾e pou¾ít $\mathbf{T}$ na výpoèet nové pozice vrcholù kù¾e. Vrchol bude poøád ve stejné relativní pozici vùèi kosti. Transformování se èasto provádí na grafické kartì ve vertex shaderu.
 \begin{figure}[h]
\begin{center}
\scalebox{0.5}{\includegraphics{fig/transform_pose.png}}
\caption{Transformace pøedloktí. Prvnì se aplikuje inverzní bind pose matice a poté aktuální transformace kosti. Model byl pøevzat z \cite{venom}.} \label{transform_pose}
\end{center}
\end{figure}
\section{Skinning}
Skinning \cite{skinningMethods} je nazýván proces pøidìlování kostí vrcholùm kù¾e a urèování jejich vah. Tento proces mù¾e probíhat algoritmicky nebo ruènì v nìkterém z modelovacích programù. Nejjednodu¹¹í zpùsob pøiøazení kù¾e ke kostøe je ka¾dé kosti pøiøadit samostatný pevný objekt jako je napø. válec. Na ka¾dý takový objekt se poté aplikuje transformace pøiøazené kosti. Tento pøístup není vhodný pro realistické animování.

Pokroèilej¹í, ale stále základní metoda je \textit{Jednoduchý skinning}, který ji¾ pou¾ívá kù¾i, tedy jeden model pro celou kostru. Pøiøazuje jeden vrchol k jedné kosti. Ka¾dý vrchol se poté transformuje podle pøiøazené kosti. Je pou¾íván napøíklad ve star¹ích hrách. Je dobøe pou¾itelný pro modely s nízkým poètem trojúhelníkù. U detailnìj¹ích modelù zpùsobuje nepìkné deformace v kloubech a animace vypadá nepøirozenì. 

\subsection{Linear blend skinning} \label{linear_blend_skinning}
\textit{Linear blend skinning} \cite{skinningMethods} je modernìj¹í algoritmus. Je nepublikovaný a vyskytuje se i pod jinými názvy jako je \textit{skeleton-subspace deformation}, \textit{enveloping} nebo pouze \textit{skinning}. Ka¾dému vrcholu umo¾òuje pøiøazení více kostí. Ka¾dá dvojice kost a vrchol má pøiøazenou váhu. Váha urèuje jak velký vliv má pohyb konkrétní kosti na výslednou pozici vrcholu. Na vstupu oèekává následující data: 
\begin{itemize}
\item Kù¾e v bind pose, typicky reprezentovaná jako polygonální model. Propojení mezi vrcholy se v prùbìhu nemìní, pouze pozice vrcholù. 
\item Transformace kostí, reprezentované jako matice $\mathbf{T}_1,\ldots,\mathbf{T}_m$ urèené podle rovnice \ref{r.transform_mat}. Tyto matice jsou typicky jediná velièina, která se v prùbìhu animace mù¾e mìnit. 
\item \label{weight_sum} Váhy vrcholù, pro ka¾dý vrchol $\mathbf{v}_i$ máme váhy $w_{i,1},\ldots,w_{i,m} \in \mathbb{R}$. Ka¾dá váha $W_{i,j}$ urèuje vliv kosti $j$ na vrchol $i$. Celkový souèet v¹ech vah je 1, pøièem¾ ¾ádná váha není záporná. 
\end{itemize}
Mno¾ství kostí ovlivòující jeden vrchol se mù¾e významnì li¹it, napø. od 1 do 10. Kvùli limitacím grafického hardwaru se èasto uva¾uje ¾e jich není více ne¾ 4. Transformovaná pozice vrcholu $\mathbf{v}'_i$ se urèí podle následující rovnice:
\begin{eqnarray}
\mathbf{v}'_i &=& \Bigg(\sum_{j=1}^mw_{i,j} \mathbf{T}_j\Bigg)\mathbf{v}_i\label{r.linear_blend_skinning}
\end{eqnarray}
 Tato metoda podává dobré výsledky, pokud míchané transformace nejsou pøíli¹ rozdílné. Problémy nastávají jestli¾e potøebujeme míchat transformace, které se významnì li¹í v jejich rotaci. Z lineární kombinace rotací nevzniká rotace. To je dùsledkem faktu, ¾e Lieova grupa 3D transformací, $SO(3)$, není lineární prostor, ale zakøivená varieta. Pokud jsou si rotace blízké není to problém. Uva¾ujme ale tyto dvì rotace.
$$\mathbf{R}_1\left[\begin{array}{ccc}
1 & 0 & 0\\
0 & 1 & 0\\
0 & 0 & 1~\end{array}\right], \quad \mathbf{R}_2 \left[\begin{array}{ccc}
-1 & 0 & 0\\
0 & -1 & 0\\
0 & 0 & 1~\end{array}\right]$$ 
  $\mathbf{R}_1$ je maticí identity a $\mathbf{R}_2$ je rotace okolo osy Z o 180°. Lineární míchání $0.5 \cdot \mathbf{R}_1 + 0.5 \cdot \mathbf{R}_2$ nám dá za výsledek matici hodnosti 1, která promítá 3D prostor na osu Z. To má za následek ztrátu objemu modelu. Velké relativní rotace nejsou vzácné, proto¾e klouby jako ramena a zápìstí mají velký rozsah pohybu. Tyto problémy je mo¾né øe¹it zavedením více parametrù ne¾ má linear blend skinning. Takové metody se nazývají \textit{multilineární}. Tyto metody ale nemusí být ¾ádoucí kvùli nutnosti vytváøet a ukládat více vah pro ka¾dý vrchol.

\subsection{Dual quaternion skinning}
Velmi roz¹íøenou metodou je nelineární metoda \textit{Dual quaternion skinning} \cite{dualQuat}, kde se místo matic míchají \textit{duální kvaterniony}. Tato metoda øe¹í artefakty vznikající u linear blend skinning, zachovává objem modelu a je velmi rychlá. Pou¾ívá se v roz¹írených modelovacích programech jako je napø. Blender. Klasické kvaterniony umo¾òují reprezentovat 3D rotaci okolo osy. Tato osa ale musí procházet poèátkem souøadného systému. Oproti tomu duální kvaterniony toto omezení nemají - osa mù¾e být libovolná. Kromì toho duální kvaterniony umo¾òují popsat posunutí. Ale neumo¾òují popsat zmìnu mìøítka. Proto nemù¾e docházet ke ztrátì objemu, jako u matic, kde násobením mù¾e vznikat zmen¹ení. Duální kvaterniony jsou také výhodné pro GPU hardware, proto¾e obsahují ménì hodnot ne¾ matice. Pro porovnání metod viz obrázek \ref{skinning_methods}.

\begin{figure}[h]
\begin{center}
\scalebox{0.5}{\includegraphics{fig/dual_quat.png}}
\caption{Zleva doprava: model v bind pose, linear blend skinning a dual quaternion skinning. Pøevzato z \cite{skinningMethods}.} \label{skinning_methods}
\end{center}
\end{figure}

\subsection{Metoda obálek}
Pøiøazení vah je mo¾né automaticky \textit{metodou obálek} \cite{envelopes}. Tato metoda je zalo¾ena na blízkosti kostí a jejich geometrie. Ka¾dá kost má dvì oblasti vlivu. Vnitøní oblast, kde je geometrie plnì ovlivnìna touto kostí. A vnìj¹í oblast, kde je geometrie ménì ovlivnìna kostí, èím blí¾e je k okraji této oblasti. 
Pokud chceme mít váhy urèené kvalitnì, je nutné nastavit váhy ruènì. To je mo¾né v nìkterém modelovacím programu, napøíklad Blender poskytuje \textit{Weight Paint} mód, kde se pohybem ¹tìtce po modelu urèují váhy vrcholù pro jednotlivé kosti. Tento proces je iterativní a nároèný. Kreslením se odebírají nebo pøidávají váhy vrcholùm pro jednu aktivní kost. Poté se zkou¹í efekt na známé póze, upravují a vyhlazují váhy a tento proces se opakuje, dokud výsledek není dostateènì pøirozený. Na obrázku \ref{envelope_weight_paint} je ukázána obálka a model ve Weight Paint módu.
\begin{figure}[h]
\begin{center}
\subfloat{{\includegraphics[width=3cm]{fig/envelopes.png}}}
\qquad
\subfloat{{\includegraphics[width=7cm]{fig/weight_paint.png}}}
\caption{Metoda obálek v programu Blender (pøevzato z \cite{envelopes}) a model \cite{venom} ve Weight paint módu v Blenderu.} \label{envelope_weight_paint}
\end{center}
\end{figure}

\section{Tvorba animace}
Animace èlovìka se vyskytuje ve velkém mno¾ství aplikací v rùzných prostøedích a podmínkách. Tyto animace by proto mìly být pøizpùsobitelné prostøedí v reálném èase. Také by mìly pùsobit pøirozenì a tím pøidávat na reálnosti. Základní nástroje pro specifikaci pohybu jsou zalo¾eny na \textit{kinematikách}. Existují dva zpùsoby popisu kinematické informace: \textit{inverzní} a \textit{pøímá kinematika}, viz kapitola \ref{kinematics}. 

Welbergen a spol. \cite{survey} dìlí techniky tvorby animace do tøí skupin: \textit{procedurální animace}, \textit{fyzikálnì zalo¾ená simulace} a \textit{editace pohybu}. Techniky se také mohou kombinovat dohromady a vyu¾ívat vhodnìj¹í techniku pro danou situaci nebo èást tìla. Mù¾e se napøíklad pou¾ít technika editace pohybu dokud nedojde k interakci s prostøedím a ta se mù¾e zpracovat pomocí fyzikálnì zalo¾ené simulace. Nebo pomocí procedurální animace vytvoøit gesta rukou a fyzikální simulací zachovat fyzikálnì pøirozené balancování spodní èásti tìla.

\subsection{Procedurální animace}
Procedurální animace popisuje animaci algoritmicky pomocí matematických vzorcù. Její úspìch závisí na tom, jak hluboce jsme schopni pochopit a modelovat simulovaný pohyb. Metody mohou popisovat rotace kostí pøímo nebo popisovat cesty koncových uzlù kostry (chodidla), potom se pou¾ívá inverzní kinematika. 

Procedurální animace umo¾òuje pøesné èasování a pozicování konèetin a mù¾e vyu¾ívat velké mno¾ství parametrù, pomocí kterých je mo¾né upravit výstup na míru po¾adavkùm. Dobøe se adaptují na prostøedí a jsou málo výpoèetnì nároèné. Nicménì je èasto problematické zakomponovat detaily jako jsou u editace pohybu do matematického popisu. Také je nutné explicitnì zachovávat fyzikální pøirozenost v procedurálním modelu pohybu pro v¹echny mo¾nosti parametrù. Je èasto pou¾ívána pro animaci gest a mluvení, které vy¾adují velké mno¾ství parametrù.

\subsection{Fyzikálnì zalo¾ená simulace}
V mnoha pøípadech je vhodné poèítat s \textit{dynamikami} \cite{surveyWalk}, aby byla zachována realistiènost pohybu. Tyto pøípady mohou být:
\begin{itemize}
\item jestli¾e postava nese náklad
\item jestli¾e postava musí reagovat na externí síly jako poryvy vìtru
\item  povrch na kterém se pohybuje je komplexní (schody atp.)
\end{itemize}

Dynamiky se pou¾ívají u technik ze skupiny fyzikálnì zalo¾ené simulace. Dynamiky jsou zalo¾ené na Newtonových pohybových zákonech. Spojují síly (resp. toèivé momenty rotací) do výsledného pohybu (resp. rotace) podle rovnice: 
\begin{eqnarray}
f=m \cdot \ddot{x}\label{r.dynamics1}
\end{eqnarray}
kde $f$ je síla aplikovaná na objekt, $m$ je jeho hmotnost, $\ddot{x}$ je druhá derivace $x$ podle èasu. Pro rotace vypadají rovnice podobnì. Toèivé momenty a úhlové pozice jsou spojeny pomocí:
\begin{eqnarray}
t=i \cdot \ddot{\theta} + \dot{\theta} \times i \cdot \ddot{\theta}\label{r.dynamics2}
\end{eqnarray} 
kde $t$ je toèivý moment, $i$ je matice setrvaènosti, $\dot{\theta}$ je úhlová rychlost a $\ddot{\theta}$ je úhlové zrychlení. \textit{Pøímá dynamika} je aplikace tìchto zákonù k výpoètu pohybu vygenerovaného danou silou. \textit{Inverzní dynamika} se zabývá urèováním síly, která by vygenerovala daný pohyb.

Ve fyzikálnì zalo¾ené simulaci je model typicky reprezentovaný jako systém pevných tìles propojených klouby. Ka¾dé z tìchto pevných tìles má pøiøazené fyzikální vlastnosti jako napø. hmotnost. Pohyb je generován manipulací s toèivými momenty kloubù s pou¾itím pøímé dynamiky. Pro umo¾nìní kolizí je nutné geometricky reprezentovat pevná tìlesa. Pou¾ití samotného povrchového modelu je pøíli¹ výpoèetnì nároèné, proto se pou¾ívají pro kolize aproximace pomoci základních tvarù, napø. válec.

Metody mohou fungovat na základì zadávání geometrických omezení jako parametrù animace. Tato omezení mohou být typicky splnìna velkým mno¾stvím rùzných toèivých momentù. Proto se mohou zavést objektivní funkce pro preferenci jistých øe¹ení. Tyto metody jsou pro animace v reálném èase velmi pomalé. Jiný zpùsob je pou¾ívání kontrolérù, do kterých vstupuje ¾ádaný stav systému. Výstupem je mno¾ina toèivých momentù kloubù, které po aplikaci na systém vedou promìnné k jejich po¾adovaným hodnotám. Kontrolér vyu¾ívá fyzikálních vlastností pohybujícího se tìla. Úlohou kontroléru je minimalizace nesrovnalostí mezi aktuálním a po¾adovaným stavem. Síly a toèivé momenty urèené kontrolérem, gravitace a síly zpùsobené externími vlivy jsou aplikované na fyzické tìlo. To je poté pohnuto pomocí pøímé dynamiky. 

Fyzikálnì zalo¾ená simulace poskytuje fyzikálnì realistický pohyb a interakci s prostøedím. Umo¾òuje zachování parametrù pod vlivem externích sil. Nicménì pøesné èasování a umis»ování konèetin je problematické. Aèkoliv fyzikální simulace poskytuje fyzikálnì správný pohyb, není èasto dostaèující pro vytvoøení pøirozeného pohybu. 

\subsection{Editace pohybu}
Metody editace pohybu vytváøí pohyb na základnì vzorù pohybu. Metody modifikace pohybu generují nová pohybová primitiva modifikací jednoho vzoru pohybu. Kombinaèní techniky vytváøí pohybová primitiva pomocí databáze vìt¹ího mno¾ství vzorových primitiv. Pohyby se mohou vytváøet pomocí technik ze zpracování signálù, interpolací mezi vzory pohybù nebo pomocí statistických modelù. 

Techniky editace pohybu zachovávají pøirozenost vstupních vzorù pohybu, ale pouze jsou-li zmìny malé. Pøirozenost i pøi vìt¹ích zmìnách je zachována technikami pou¾ívající více vzorù na jeden pohyb. Nicménì pro v¹echny techniky roste poèet vzorù  exponenciálnì s poètem parametrù animace. Navíc techniky editace pohybu neposkytují fyzikální interakci s prostøedím, ale jsou vázány na specifický kontext. Jsou vhodné pro vytváøení animací v pøedstihu pro neinteraktivní aplikace, napø. filmy. Pro interaktivní (napø. videohry) je potøeba velká databáze pohybù. Pohyby se mohou vytváøet pomocí technik ze zpracování signálù, interpolací mezi vzory pohybù nebo pomocí statistických modelù.

Vstupní data mohou být být tvoøená animátorem ruènì, ale mohou být získána i napø. pomocí \textit{motion capture}. Motion capture  \cite{motion_capture} jsou techniky pro nahrávání pohybù èlovìka, zvíøete nebo jiného subjektu. Mají velké vyu¾ití ve filmech a videohrách. Nejèastìji se pou¾ívá optických metod pro zachycení pohybu. V Motion capture má herec okolo ka¾dého kloubu znaèky, které jsou zaznamenávány a sledovány kamerami, viz obrázek \ref{motion_capture_img}. Výstupem je mno¾ina lokací bodù v èase. Tìmi se poté prolo¾í kostra.
\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/motion_capture.jpg}}
\caption{Automatická rekonstukce kostry podle pozic znaèek. Pøevzato z \cite{motion_capture}.} \label{motion_capture_img}
\end{center}
\end{figure}

\chapter{Kinematiky} 
\label{kinematics}
Kinematiky v poèítaèové grafice slou¾í pro manipulaci s kostrou. Jsou  rozdìleny na dvì èásti: pøímá a inverzní kinematika. V pøímé kinematice se hýbe s ka¾dou kostí v øetìzci kostí a podle toho se urèí výsledná pozice posledního èlánku - \textit{koncového efektoru}. Výsledky pøi ruèním vytváøení animace jsou velmi závislé na schopnostech animátora, proto¾e musí nastavovat pozice kostí od ruky. V této technice je obtí¾né omezovat pohyb, napøíklad ¾e chodidlo nemù¾e proniknout do zemì. 

Máme-li \textit{øetìzec kloubù}, kde ka¾dý kloub $i$ má pøiøazen úhel $\theta_i$, který urèuje jeho rotaci oproti jeho pøedkovi, viz obrázek \ref{ik_chain}. Potom stav øetìzce je urèen stavovým vektorem $\boldsymbol{\theta}(\theta_1,\dots,\theta_n)$. Oznaème pozici koncového efektoru $\mathbf{P}$. Pøímá kinematika øe¹í následující rovnici:
\begin{eqnarray}
\mathbf{P} = f(\boldsymbol{\theta})\label{r.forward_kinematics}
\end{eqnarray}
Ka¾dý kloub mù¾e mít více ne¾ jeden \textit{stupeò volnosti}, tedy být definován více úhly. Tím je urèena slo¾itost struktury kloubù, která je definována jako souèet stupòù volnosti v¹ech prvkù.

Oproti tomu v inverzní kinematice \cite{Buss09introductionto,welman} se hýbe pouze s koncovým efektorem a pohyb ostatních kloubù se dopoèítá, tak aby byl tento pohyb umo¾nìn. To je matematicky zapsáno následovnì:
\begin{eqnarray}
\boldsymbol{\theta} = f^{-1}(\mathbf{P})\label{r.inverse_kinematics}
\end{eqnarray}

\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/ik_chain.eps}}
\caption{Pøíklad øetìzce tøí kloubù.} \label{ik_chain}
\end{center}
\end{figure}
Øe¹ení inverzní kinematiky není tak jednoduché jako pøímé. Funkce $f$ je nelineární a aèkoliv v rovnici \ref{r.forward_kinematics} existuje unikátní namapování z $\boldsymbol{\theta}$ na $\mathbf{P}$, pro inverzní mapování v rovnici \ref{r.inverse_kinematics} mù¾e být nekoneèné mno¾ství $\boldsymbol{\theta}$ pro jedno konkrétní $\mathbf{P}$. Analytické øe¹ení pro libovolný øetìzec kloubù neexistuje. Problém ze øe¹í pomocí numerických metod pro øe¹ení systémù nelineárních rovnic. Z nekoneèného mno¾ství øe¹ení je snaha vybírat to nejvhodnìj¹í øe¹ení. Rùzné metody preferují rùzné øe¹ení a proto se metody vybírají na základì konkrétnì øe¹eného problému. V pøípadì lidské kostry má ka¾dý kloub urèené stupnì volnosti, aby rotovali jenom v urèitých smìrech a také je definován maximální úhel rotace. Napøíklad koleno rotuje pouze v jednom smìru a nemù¾e být otevøeno více ne¾ 180° a zavøeno ménì ne¾ cca 30°. Inverzní kinematika poskytuje lep¹í kontrolu nad koncovým efektorem, jeho¾ cílová pozice nás vìt¹inou nejvíce zajímá. V modelovacím programu mù¾eme hýbat napø. pouze chodidlem a nemusíme také pohybovat stehenní a lýtkovou kostí. Toho se také vyu¾ije v procedurální animaci lidské chùze, kde budeme urèovat trajektorie koncových efektorù. Techniky zalo¾ené na kinematikách vyu¾ívají empirickou a biomechanickou znalost pohybu pro generování animace. 

Nyní si uká¾eme nìkteré zpùsoby øe¹ení inverzní kinematiky.
\section{Jacobiho inverzní metoda}
\textit{Jacobiho inverzní metoda} \cite{Buss09introductionto, welman, AristidouTR632} je iterativní metoda vyu¾ívající \textit{Jacobiho matice} k aproximaci øe¹ení. Vztah mezi kartézským prostorem koncového efektoru $\mathbf{P}$ a prostoru kloubù úhlù $\boldsymbol{\theta}$ je:
\begin{eqnarray}
\mathbf{\dot{P}} = J(\boldsymbol{\theta})\boldsymbol{\dot{\theta}}\label{r.jacobian_vztah}
\end{eqnarray}
kde teèka znaèí první derivaci podle èasu. Jacobiho matice $J$ je $m \times n$ matice:
\begin{eqnarray}
J(\boldsymbol{\theta}) = \bigg(\frac{\partial P_i}{\partial \theta_j}\bigg)_{i,j}\label{r.jacobian_matrix}
\end{eqnarray}
kde $m$ je poèet dimenzí pozice koncového efektoru $\mathbf{P}$, $n$ je poèet dimenzí $\boldsymbol{\theta}$, $i = 1,\dots,m$ a $j = 1,\dots,n$. $J$ je matice èásteèných derivací celého øetìzce relativnì ke koncovému efektoru. $J$ mapuje zmìny promìnných kloubù $\boldsymbol{\theta}$ na zmìny v pozici koncového efektoru. Sloupec $i$ v $J$ reprezentuje inkrementální zmìnu pozice koncového efektoru zpùsobenou inkrementální zmìnou promìnné $\theta_i$. 
Neznámou pro inverzní kinematiku je $\boldsymbol{\dot{\theta}}$, proto potøebujeme inverzi Jacobiho matice. Vztah je následující:
\begin{eqnarray}
\boldsymbol{\dot{\theta}} = J^{-1}(\boldsymbol{\theta})\mathbf{\dot{P}}\label{r.jacobian_vztah_inverse}
\end{eqnarray}
Poté co urèíme Jacobiho matici, hledáme hodnotu $\Delta\boldsymbol{\theta}$ pro inkrementaci $\boldsymbol{\theta}$:
\begin{eqnarray}
\boldsymbol{\theta} = \boldsymbol{\theta} + \Delta\boldsymbol{\theta}\label{r.jacobian_increment}
\end{eqnarray}
Zmìna v pozici koncového efektoru urèená touto zmìnou je:
\begin{eqnarray}
\Delta\vec{\mathbf{s}} \thickapprox J\Delta\boldsymbol{\theta}\label{r.jacobian_change}
\end{eqnarray}
Hodnota $\Delta\boldsymbol{\theta}$ by mìla být vybrána tak, aby $\Delta\vec{\mathbf{s}}$ pøibli¾nì odpovídala $\vec{\mathbf{e}}$ - rozdílu mezí cílovou a aktuální pozicí koncového efektoru. Potom pøímá kinematika mù¾e být pøepsána jako $\vec{\mathbf{e}} = J\Delta\boldsymbol{\theta}$ a inverzní jako $\Delta\boldsymbol{\theta} = J^{-1}\vec{\mathbf{e}}$.

Jacobiho matice ale není v¾dy invertibilní, tzn. není ètvercová a zároveò singulární. To nastane kdy¾ konfigurace kloubù je redundantní nebo kdy¾ prochází skrz nebo blízko singulární konfigurace.

Øetìzec kloubù je redundantní jestli¾e obsahuje více stupòù volnosti, ne¾ je potøeba pro specifikaci cíle koncového efektoru. Je-li cíl koncového efektoru urèen pozicí v 3D prostoru, potom jakýkoliv øetìzec obsahující více ne¾ 3 stupnì volnosti je redundantní a tedy existuje nekoneènì mnoho øe¹ení. Jacobiho matice potom má více sloupcù ne¾ øádkù. V takových pøípadech se $J^{-1}$ nahradí generalizovanou inverzí $J^{\dagger}$, vet¹inou \textit{Moore-Penroseovou pseudoinverzí}. Jestli¾e existuje nekoneèné mno¾ství øe¹ení, je mo¾né toho vyu¾ít pro splnìní nìjakého sekundárního kriteria, napø. vyhnutí se pøeká¾kám.
Matice je singulární jestli¾e dva nebo více øádkù jsou lineárnì závislé, pøíklad takové konfigurace je vidìt na obrázku \ref{singular}. Jacobiho matice pro takovou konfiguraci bude obsahovat nuly v prvním øádku a nemù¾e být invertována. V takovém pøípadì je mo¾né pou¾ít pseudoinverzní matici, která poskytne øe¹ení v singulární konfiguraci, nicménì v okolí singulární konfigurace bude nevhodnì oscilovat. 
\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/singular.eps}}
\caption{Singulární konfigurace øetìzce kloubù.} \label{singular}
\end{center}
\end{figure}
\section{Cyclic Coordinate Descent} \label{ccd}
\textit{Cyclic Coordinate Descent} (CCD) \cite{welman} je øe¹ení inverzní kinematiky zalo¾ené na iterativním heuristickém vyhledávání, které se sna¾í o minimalizaci rotaèní chyby  zpracováváním jednoho kloubu v jeden okam¾ik. Ka¾dá iterace provede jednotlivì pohyb v¹ech èlánkù od nejposlednìj¹ího k prvnímu. To se opakuje dokud se nedosáhne po¾adované pozice koncového efektoru a nebo dokud se nepøesáhne maximální poèet cyklù. K urèení úhlu rotace se pou¾ívají dva vektory. Proto¾e metoda pracuje s jedním kloubem v jeden okam¾ik, zvýhodòuje klouby na zaèátku. Oproti metodám pou¾ívající Jacobiho matice provádí více iterací. Aèkoliv je algoritmus jednoduchý, je èasto nutné ho dále pøizpùsobovat, aby bylo dosa¾eno vhodných výsledkù.

Mìjme iteraci $i$ (viz obrázek \ref{ccd_img}) a pozici kloubu $\mathbf{k}_i$ pro $i$-tý kloub od konce øetìzce. Potom vektor $\mathbf{P}_{ia}$ je vektor od pozice kloubu $\mathbf{k}_i$ k aktuální pozici koncového efektoru a $\mathbf{P}_{ip}$ je vektor od $\mathbf{k}_i$ do po¾adované pozice koncového efektoru. Budeme-li rotovat vektor $\mathbf{P}_{ia}$ o úhel $\phi$, dostaneme nový vektor $\mathbf{P}'_{ia}(\phi)$. Jestli¾e úhel bude nabývat libovolných hodnot, $\mathbf{P}'_{ia}(\phi)$ zaène tvoøit kruh se støedem $\mathbf{k}_i$. Bod na tomto kruhu nejblí¾e k po¾adované pozici $\mathbf{P}_p$, je bod, na kterém kruh protíná pøímku urèenou vektorem $\mathbf{P}_{ip}$. Proto budeme mìnit rotaci kloubu $\mathbf{k}_i$ tak, aby se $\mathbf{P}_{ip}$ a $\mathbf{P}'_{ia}(\phi)$ zarovnaly.
\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/ccd.eps}}
\caption{Ukázka jedné iterace metody CCD.} \label{ccd_img}
\end{center}
\end{figure}
Úhel $\phi$ který hledáme, je úhel, který maximalizuje následující funkci:
\begin{eqnarray}
g(\phi) &=& k_1(1 - \cos\phi) + k_2 \cos\phi + k_3 \sin\phi\label{r.ccd_max1}
\end{eqnarray}
kde $k_1$, $k_2$ a $k_3$ jsou konstantní koeficienty, pro detaily viz \cite{welman}. Funkce má maximum v intervalu $-\pi \leq \phi \leq \pi$, kdy¾ je první derivace nula a druhá derivace je záporná. Z první podmínky dostáváme rovnici:
\begin{eqnarray}
\phi &=& \tan^{-1}\frac{k_3}{k_2 - k_1}\label{r.ccd_max2}
\end{eqnarray}
která vymezí kandidátní hodnotu $\phi_c$ v rozsahu $\frac{-\pi}{2} \leq \phi_c \leq \frac{\pi}{2}$. Proto¾e $\tan$ je periodické, musíme uva¾ovat i dvì dal¹í kandidátní hodnoty: $\phi_c + \pi$ a $\phi_c - \pi$. Z kandidátních hodnot se vybere taková, která spadá do intervalu $-\pi \leq x \leq \pi$ a její¾ druhá derivace je záporná. Je-li jich více, funkce se vyhodnotí nad v¹emi a vybere se z nich maximum. Poté co jsme získali úhel $\phi$, mù¾eme ho vynásobit váhou urèující tuhost kloubu a pøièíst ho k aktuální rotaci $r_i$ kloubu $i$. Poté se pokraèuje s iterací $i+1$.
\chapter{Lidská chùze}
Lidská chùze \cite{gait_review} se skládá z opakujících se \textit{krokových cyklù} neboli \textit{dvojkrokù}, viz obrázek \ref{gait_cycle}. Cyklus je sekvence pohybù od doby kdy se jedna noha dotkne zemì do doby kdy se stejná noha dotkne zemì znovu. Ka¾dý krokový cyklus má dvì základní fáze: \textit{stojnou fázi} a \textit{¹vihovou fázi}. Proto¾e je cyklus shodný pro obì nohy, budeme popisovat pouze jednu.

Stojná fáze, je fáze, kdy je noha v kontaktu se zemí. Zabírá 60\% dvojkroku a zaèíná s \textit{úderem paty} (\textit{poèáteèní kontakt}) a konèí s \textit{odrazem palce}. Je dále rozdìlena do podfází:
\begin{itemize}
\item \textit{stádium zatì¾ování}
\item \textit{mezistoj}
\item \textit{koneèný stoj}
\item \textit{pøed¹vihová fáze}
\end{itemize}
Po poèáteèním kontaktu pravé nohy nastává perioda \textit{dvojí opory}, která konèí pøi odrazu palce levé nohy. Následuje \textit{jedno-oporová fáze} do té doby, ne¾ se levá dostane do poèáteèního kontaktu. Nastává druhá perioda dvojí opory, a¾ do odrazu palce pravé nohy. V ka¾dé fázi dvojí opory je jedna noha vpøedu, právì se dotkla zemì. A druhá je vzadu pøipravena na zvednutí se ze zemì. Pøední noha je ve stadiu zatì¾ování  a zadní je v koneèném ¹vihu. V ka¾dém krokovém cyklu jsou dvì periody dvojí opory a dvì periody jedno-oporové fáze. Dvojí opora zabírá pøibli¾nì 10\% dvojkroku, ale její délka se mìní s rychlostí chùze. S vìt¹í rychlostí se prodlu¾uje ¹vihová fáze a zkracuje fáze dvojí opory. Kdy¾ dvojí opora úplnì vymizí z chùze se stává bìh. Mezi kroky bìhu je fáze letu, kdy není ¾ádná noha na zemi.

©vihová fáze nastává kdy¾ je chodidlo ve vzduchu a trvá 40\% délky dvojkroku. Zaèíná s úderem paty a konèí s druhým odrazem palce.  Je dále rozdìlena do podfází:
\begin{itemize}
\item \textit{poèáteèní ¹vih}
\item \textit{mezi¹vih}
\item \textit{koneèný ¹vih}
\end{itemize}

\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/gait-cycle.jpg}}
\caption{Krokový cyklus a jeho fáze. Pøevzato z \cite{gait_img}.} \label{gait_cycle}
\end{center}
\end{figure}

Nyní si popí¹eme nìkteré termíny a parametry specifikující chùzi (obr. \ref{step_length}). \textit{Délka dvojkroku} je vzdálenost mezi dvìma po sobì jdoucími kroky stejné nohy. Skládá se ze dvou délek kroku, levé a pravé, ka¾dá s nich urèuje vzdálenost o kterou se jedna noha pøesune pøed druhou. Mù¾e být napø. nulová, kdy¾ se levá noha pøesune na úroveò pravé a ne pøed ní. \textit{©íøka dvojkroku} je vzdálenost mezi pøímkami urèenými støedy pat obou nohou pøi chùzi. \textit{Úhel vytoèení chodidla} urèuje úhel mezi zmínìnou pøímkou a pøímkou procházející støedem chodidla. \textit{Kadence} je poèet krokù v daném èase. V jednom krokovém cyklu jsou dva kroky a tedy kadence je mìøítko  pùl-cyklù. Èas dvojkroku $c$ v sekundách se urèí jako $c = 120/kad$, kde $kad$ je kadence v krocích za minutu. \textit{Rychlost chùze} je vzdálenost u¹lá v èase. Okam¾itá rychlost je variabilní v prùbìhu kroku, ale prùmìrná rychlost je výsledkem kadence a délky dvojkroku. Rychlost chùze $r$ se spoèítá jako $r = d/c$, kde $d$ je délka dvojkroku. Rychlost chùze tedy závisí na délce kroku, které závisí na délce ¹vihové fáze.

\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/step_length.png}}
\caption{Délka, ¹íøka kroku a úhel vytoèení chodidla. Pøevzato z \cite{gait_review}.} \label{step_length}
\end{center}
\end{figure}

\section{Fáze krokového cyklu}
Tato sekce obsahuje podrobný popis jednotlivých fází krokového cyklu. Ka¾dá z osmi fází má funkèní objektiv. Sekvenèní kombinace fází umo¾òuje konèetinì dosáhnout tøí základních úkolù. Tìmi jsou pøesun hmotnosti tìla, jednooporová fáze a posun konèetiny ve ¹vihové fázi. Tato podkapitola byla pøevzata z \cite{gait_review}. 
\subsection{Poèáteèní kontakt}
V této fázi je kyèel ohnutá, koleno nata¾ené a kotník v neutrální poloze. Kontakt se zemí je dosa¾en pomocí paty, která se stává støedem otáèení. Druhá noha je na konci koneèného stoje. Tato fáze obsahuje moment kdy právì nastane dotyk nohy se zemí. Dr¾ení tìla v tuto chvíli urèuje pohyb konèetiny ve stadiu zatì¾ování. 
\subsection{stádium zatì¾ování}
stádium zatì¾ování je fáze, kde je váha tìla pøenesena na pøední nohu. Koleno je pokrèeno pro absorbci ¹oku. Chodidlo se dostává do plného kontaktu se zemí. Protilehlá noha je v pøed¹vihové fázi. Tato fáze je poèátkem fáze dvojí opory. Pokraèuje dokud nezaène být druhá noha zvedána ke ¹vihu. 
\subsection{Mezistoj}
V mezistoji dochází k posunutí dolní konèetiny pøes zafixované chodidlo, zatímco koleno a kotník se propínají. Protilehlá noha se nachází uprostøed mezi¹vihové fáze. Je to první polovina intervalu stoje na pouze jedné noze. Trvá od zvednutí druhé nohy dokud váha není pøesunuta po chodidle do oblasti pøedno¾í. 
\subsection{Koneèný stoj}
Bìhem druhé poloviny intervalu stoje na jedné noze se zvedne pata a støed otáèení stojné konèetiny se pøesune do pøední èásti nohy. Koleno zvý¹í své propnutí a poté se zaène lehce ohýbat, kyèel se propíná. Druhá noha je v koneèném ¹vihu. Zaèíná se zdvihem paty a konèí v okam¾iku kontaktu paty druhé nohy se zemí. Váha tìla je pøesunuta pøed nohu. 
\subsection{Pøed¹vihová fáze}
Kontakt se zemí druhé nohy zaèal dal¹í fázi dvojí opory. Referenèní noha zvý¹í ohyb v kotníku a v koleni, kyèel ji¾ není propnutá. Protilehlá noha je ve stadiu zatì¾ování. Tato poslední podfáze stojné fáze je druhým (a posledním) intervalem dvojí opory v krokovém cyklu. Zaèíná s poèáteèním kontaktem druhé nohy a konèí s odrazem palce referenèní nohy. Váha je uvolnìna z referenèní nohy a pøenesena na nohu druhou. Uvolnìná noha vyu¾ije volnosti k pøípravì na ¹vihovou fázi, k èemu¾ slou¾í v¹echny pohyby a svalové akce odehrávající se v tuto dobu.
\subsection{Poèáteèní ¹vih}
Chodidlo je zvednuto a pøesunuto vpøed pomocí ohybu v kyèli a koleni. Kotník èásteènì dorziflexuje (ohyb kotníku smìrem k høbetu nohy). Druhá konèetina je na zaèátku mezi¹vihu. Tato fáze je pøibli¾nì tøetina ¹vihové periody. Zaèíná kdy¾ noha opustí podlo¾ku a konèí v okam¾iku maximálního propnutí v koleni.
\subsection{Mezi¹vih}
Pøesun nohy dopøedu je získán dal¹ím ohybem v kyèli. Koleno se propíná  a kotník dorziflexuje do neutrální polohy. Druhá noha je na konci mezistoje. Tato druhá fáze ¹vihové periody zaèíná kdy¾ je ¹vihová noha  naproti stojné noze. Konèí kdy¾ je holení kost ve vertikálním postavení - ohyb kolene a kyèle je shodný.
\subsection{Koneèný ¹vih}
Pøesun chodidla je ukonèen propnutím kolene a pøesunem holenì pøed stehno. Kyèel si zachovává ohyb z pøedchozí fáze. Kotník zùstává v neutrální poloze. Druhá noha je v koneèném stoji. Tato poslední fáze ¹vihu zaèíná s vertikální holení kostí a konèí pøi kontaktu nohy se zemí. Touto fází je pøesun nohy ukonèen.

\chapter{Existující implementace}
V této kapitole jsou popsány nìkteré existující implementace procedurální animace lidské chùze. Je ukázáno jak se vyu¾ívá znalostí o lidské chùzi a jak je mo¾né animaci ovlivòovat pomocí parametrù.
\section{Interactive Animation of Personalized Human Locomotion}
V èlánku Interactive Animation of Personalized Human Locomotion \cite{bruderlin} je popsán systém pro tvorbu lidského pohybu pomocí procedurální animace. Umo¾òuje specifikaci tøí parametrù: délka kroku, kadence krokù a rychlost. A 15 atributù jako je napø. rotace a náklon pánve. Díky tìmto atributùm je umo¾nìna individualizace pohybu pro starého èlovìka, malé dítì apod. Tento systém je plnì kinematický. 

Pro ka¾dý krok jsou vypoèítány tøi omezení ze specifikovaných parametrù a atributù: doba trvání fází kroku (stojná a ¹vihová), úhly nohy na konci kroku a kontrolní body urèující pohyb kyèle stojné nohy bìhem kroku. Urèují se ètyøi kontrolní body zvlá¹» pro vertikální a horizontální komponent. První a  poslední bod se urèí z délky kroku a úhlù nohy na zaèátku a konci kroku. Druhý a tøetí kontrolní bod se urèí na základì znalosti, ¾e vertikální pøesun je nejni¾¹í uprostøed dvojí opory a nejvy¹¹í uprostøed ¹vihové fáze. Zatímco horizontální pøesun má maximum a minimum opaènì. To je v korelaci s výdajem energie bìhen jednoho dvojkroku, jak je vidìt na obrázku \ref{bruderlin_img}, kde potenciální energie je identická s vertikálním pøesunem a kinetická s horizontálním. Mezi body z ka¾dé mno¾iny jsou prolo¾eny interpolaèní spline køivky a tím je urèen pohyb kyèle pro stojnou nohu bìhem kroku. Pozice prstù nohy je statická bìhem stojné fáze. Úhly zbylých kloubù nohy jsou dopoèítány pomocí inverzní kinematiky.

\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/bruderlin.png}}
\caption{Aproximace kinetických a potenciálních energií horní poloviny tìla pro prùmìrný krok. Pøevzato z \cite{bruderlin}.} \label{bruderlin_img}
\end{center}
\end{figure}

Tím je urèen pohyb stojné nohy. Dále se urèí rotace, úklon a náklon pánve. Rotace pánve je na maximu pøi úderu paty na zem a na minimu v mezistoji. Úklon pánve má minimum pøi úderu paty a maximum na konci dvojí opory. Náklon pánve je zpùsobem tím, ¾e se tìlo v¾dy nakloní na stranu nohy nesoucí váhu. Je minimální pøi úderu paty a maximální uprostøed stojné fáze. Pozice kyèle nohy ve ¹vihu je urèena interpolací tìchto hodnot. Pohyb nohy ve ¹vihu je rozdìlen do tøí fází a urèen lineární interpolací. Pohyb horní poloviny tìla je urèen v závislosti na spodní, napø. ruka se hýbe dopøedu s protilehlou nohou. Pohyb ruky a rotace ramene je urèen nastavitelnými atributy.

\section{Animation of Human Walking in Virtual Environments}
Kontrolní systém pro animaci lidské chùze po nerovném terénu je prezentován v èlánku Animation of Human Walking in Virtual Environments \cite{chung}. Pou¾ívá se model èlovìka s 18 klouby a celkem 36 stupni volnosti. 

Kontrola pohybu na nejvy¹¹í úrovni umo¾òuje u¾ivateli animovat pohyby s malým mno¾stvím parametrù. U¾ivatel specifikuje cestu pohybu pomocí kubických splinù v horizontální rovinì. Z parametrù vý¹ky èlovìka a rychlosti chùze je vygenerována délka a frekvence kroku. Pro normální chùzi mù¾e být vztah urèen jako v rovnici:
\begin{eqnarray}
l &=& \sqrt{0.004 \times s \times h}\label{r.step_length}
\end{eqnarray}
kde $l$ je délka kroku, $s$ je rychlost trupu a $h$ je vý¹ka èlovìka.
Výpoèet pozice chodidla na terénu je urèen jako funkce délky kroku, zmìny smìru globální cesty a stavu terénu. Prvnì jsou pozice chodidel rovnomìrnì rozlo¾eny po køivce cesty v horizontální rovinì. Pøesáhne-li rotace chodidla prahovou hodnotu, je krok zkrácen, ale doba provedení kroku zùstane zachována. Stav terénù ve 3D je zkontrolován pro urèení bezkolizních trajektorií nohou. 

Na støední úrovni kontroly jsou poskytnuty atributy pro kontrolu spodní èásti tìla. Prvnì se odhadnou úhly dopadu a zvednutí chodidla stojící nohy. Z tìchto odhadnutých hodnot a podle pøibli¾né trajektorie pánve jsou pomocí inverzí kinematiky dopoèítány úhly kolene a kyèle. Poté jsou pøesnì dopoèítány úhly dopadu a zvednutí chodidla. Trajektorie chodidla se urèí lineární interpolací mezi polo¾eným chodidlem na zemi a úhly dopadu a zvednutí chodidla. Tím je urèena trajektorie stojící nohy, jednoho z koncových efektorù pro øetìzec inverzní kinematiky. Nyní je potøeba urèit pohyb koøene øetìzce, pánve. 

Observace ukázaly, ¾e trajektorie pánve pøibli¾nì odpovídá sinusoidì, viz obrázek \ref{chung_pelvis}. Pro interpolaci jsou pou¾ity kubické spliny, konkrétnì Beziérova køivka. Pánev prochází vertikálním maximem uprostøed stojné fáze, tato hodnota se urèí podle velikosti ohybu kolene. Pánev prochází minimem uprostøed intervalu dvojí opory, kdy obì nohy jsou v kontaktu se zemí. Pozice v této fázi je urèena tak, aby byla minimalizována suma úhlových zrychlení v¹ech kloubù podpírající nohy. U¾ivatel mù¾e tìmto kloubùm nastavovat váhy. Výsledná Beziérova køivka je poté nerovnomìrnì vzorkována, aby bylo dosa¾eno nejrychlej¹ího pohybu bìhem dvojí opory a nejpomalej¹ího uprostøed stojné fáze. 
\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/chung_pelvis.png}}
\caption{3D trajektorie (c) je urèena z vertikálního (a) a horizontálního (b) posuvu. Pøevzato z \cite{chung}.} \label{chung_pelvis}
\end{center}
\end{figure}
Pro definici trajektorie chodidla nohy ve ¹vihové fázi se pou¾ijí Beziérovy køivky obdobnì jako pøi pohybu pánve. Spolu se znalostí pozice koøene (pánve) kinematického øetìzce se dopoèítají pozice ostatních kloubù. Trajektorie se urèí tak, aby se chodidlo vyhnulo kolizím a aby byla spotøebována co nejmen¹í energie. Na nejni¾¹í úrovni je poté mo¾né nastavit dal¹í atributy, napø. rotace a náklon pánve.

\chapter{Návrh a realizace øe¹ení}
Øe¹ení je implementováno v jazyce C++. 3D grafika je vykreslena pomocí rozhraní OpenGL. OpenGL je multiplatformní rozhraní, podporováno mno¾stvím programovacích jazykù, umo¾òující vykreslování 2D a 3D grafiky. Komunikuje s grafickým procesorem pro hardwarovì akcelerované vykreslování. Pro zpracování vstupù a vytvoøení kontextu OpenGL je vyu¾ita knihovna SDL 2.0. SDL je multiplatformní knihovna umo¾òující nízkoúrovòový pøístup ke klávesnici, my¹i, zvuku a grafickému hardwaru. Funguje nativnì v C++.

Aplikace bude umo¾òovat naètení pøedpøipraveného modelu s pøipojenou kostrou. Pøípadnì u¾ivatel mù¾e vyu¾ít poskytnutou pøedpøipravenou kostru a na ní pøipojit vlastní model a ten poté vyexportovat v Blenderu do formátu \textit{COLLADA}. Aplikace model zobrazí za vyu¾ití Linear blend skinning (kapitola \ref{linear_blend_skinning}) algoritmu. U¾ivatel bude mít mo¾nost zobrazení pouze kù¾e modelu, nebo kostry, nebo obojího zároveò. Model bude rozhýbán animací chùze. Bude mo¾né upravit animaci pomocí nìkolika parametrù. K tomu bude vyu¾ito grafické u¾ivatelské rozhraní. Animace následnì bude moct být vyexportována a následnì pou¾ita napøíklad v herním enginu Unity.

\section{Naètení modelu}
Model je naèítán z formátu COLLADA, který podporuje ulo¾ení geometrie, efektù, fyziky, animace, kinematik scény aj. Vyu¾ívá XML schéma. Pøi naèítání uva¾ujeme, ¾e model do tohoto formátu byl exportován z Blenderu.

Zaène se naètením geometrie modelu z XML elementu  \texttt{library\_geometries}. Ulo¾í se pole s pozicemi vrcholù, normálami a texturovacími koordináty. Naètou se seznamy polygonù, které jsou urèeny odkazy do polí naètených v pøedchozím kroku. Oèekává se pou¾ití pouze trojúhelníkù. Tìchto seznamù mù¾e být více, li¹í se pou¾itým materiálem a v na¹í aplikaci jeden tento seznam tvoøí jeden  \textit{Mesh} (kód \ref{weighted_mesh}). Název materiálu je nastavený v Blenderu a pøi naèítání modelu se oèekává pøilo¾ení textury se shodným názvem a pøíponou \texttt{\_D} pro difuzní texturu.

\begin{lstlisting}[float,floatplacement=H,language=C++, caption={Tøída modelu.}, label={weighted_mesh}]
class Mesh {
protected:
  std::vector<glm::vec3> v; //pozice vrcholu
  std::vector<glm::vec3> n; //normaly
  std::vector<glm::vec2> t; //texturovaci koordinaty
  std::shared_ptr<Material> m; //material
public:
  /* ... */ };
  
class WeightedMesh : public Mesh {
private:
  std::vector<glm::vec4> weights; //vahy prirazenych kosti
  std::vector<glm::ivec4> jointIndices; //prirazene kosti
public:
  /* ... */ };
\end{lstlisting}

Následuje naètení vah a pøiøazení kostí vrcholùm z XML elementu  \texttt{library\_controllers}. První se pøeète \textit{bind shape} matice. Ta popisuje transformaci geometrie do správného souøadného systému pro pou¾ití s klouby. Poté je naèten seznam názvù kostí, seznam inverzních bind pose matic $\mathbf{B}_i$ (viz rovnice \ref{r.transform_mat}) pro ka¾dou kost a seznam vah vrcholù. Následuje seznam, který urèuje pro ka¾dý vrchol poèet kostí, které ho ovlivòují a stejný poèet odkazù do seznamu kostí a vah.

Nyní se naète samotná hierarchie kostry z XML elementu \texttt{library\_visual\_scenes}. První uzel obsahuje koøenovou transformaci, od které se odvíjí dal¹í transformace v¹ech kostí. Kosti jsou hierarchicky zanoøené, obsahují název a lokální transformaèní matici, viz kód \ref{collada_skeleton}. Kosti se ukládají do 2D pole, kde ka¾dá kost má ulo¾ený index nadøazeného uzlu, tedy rodièovské kosti a $0 \dots n$ indexù na své potomky, viz kód \ref{class_skeleton}. Kostem se následnì pøiøadí inverzní bind pose matice vynásobené bind shape maticí, ta se dále neukládá. Pro správné zobrazení kostry je nutné urèit velikost kostí, ta se urèí jako rozdíl pozice dané kosti a jejího potomka. Pokud ale kost nemá ¾ádného potomka nemù¾eme zjistit její velikost. Proto uva¾ujeme polovièní velikost ne¾ je velikost rodièovské kosti. Dále jsme zavedli mo¾nost pøidat kost, která se pou¾ije pouze pro urèení velikosti a poté se odstraní, taková kost musí ve svém názvu obsahovat \textit{empty}.

\begin{lstlisting}[float,floatplacement=H,language=C++, caption={Tøída kostry.}, label={class_skeleton}
]
struct Bone {
  glm::mat4 localMat; //lokalni transformace
  glm::mat4 inverseBindMatrix; //inverzni bind pose matice
  int parent; //odkaz na rodicovskou kost
  std::vector<int> childs; //odkaz na potomky
  float scale; //velikost kosti, slouzi pro zobrazeni kosti 
};

class Skeleton {
private:
  std::vector<Bone> bones; //pole kosti
  glm::mat4 rootTransform; //korenova transformacni matice
  std::vector<glm::mat4> globalMat; //globalni transformace
public:
  /* ... */ };
\end{lstlisting}

Nakonec jsou naplnìny objekty tøídy \texttt{WeightedMesh} (kód \ref{weighted_mesh}). Abychom mohli pou¾ít \texttt{vec4} pro vstup kostí do vertex shaderu, musí mít ka¾dý vrchol pøiøazené maximálnì ètyøi kosti. Pro model lidského tìla jsou ètyøi kosti dostateèné a pokud je jich více, mají nìkteré velmi nízké váhy. Proto jsou pro ka¾dý vrchol seøazeny v¹echny jeho kosti sestupnì podle vah a ulo¾eny pouze první ètyøi. Váhy ostatních jsou rozlo¾eny rovnomìrnì mezi ostatní, aby zùstala zachována podmínka o celkovém souètu v¹ech vah (viz \ref{weight_sum}).

\begin{lstlisting}[float,floatplacement=H,language=XML, caption={Ukázka ulo¾ení hierarchie kostry ve formátu COLLADA.}, label={collada_skeleton}]
<library_visual_scenes>
  <visual_scene id="Scene" name="Scene">
    <!-- ... -->
    <node id="metarig" name="metarig" type="NODE">
      <matrix sid="transform">1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 1</matrix>
      <node id="hips" name="hips" sid="hips" type="JOINT">
        <matrix sid="transform">
          1 0 0 0 0 -0.16 -0.98 0.05 0 0.98 -0.167 1.01 0 0 0 1
        </matrix>
        <node id="spine" name="spine" sid="spine" type="JOINT">
          <matrix sid="transform">
            1 0 0 0 0 0.99 0.11 0.17 0 -0.11 0.99 1.49e-8 0 0 0 1
          </matrix>
          <node id="chest" name="chest" sid="chest" type="JOINT">
            <matrix sid="transform">
              1 0 0 0 0 0.99 0.14 0.15 0 -0.14 0.99 7.45e-9 0 0 0 1
            </matrix>
            <!-- ... -->
          </node>
        </node>
        <!-- ... -->
      </node>
    </node>
    <!-- ... -->
  </visual_scene>
</library_visual_scenes>
\end{lstlisting}

\section{Zobrazení}
Pøed ka¾dým zobrazením snímku je nutné spoèítat globální transformaèní matice pro v¹echny kosti kostry. Proto procházíme pole s kostmi a pro ka¾dou kost vynásobíme globální matici rodièe s její lokální maticí. Poté získáme transformaèní matici $\mathbf{T}$ podle rovnice \ref{r.transform_mat}. Následnì nastavíme koøenovou transformaèní matici jako transformaèní matici modelu. Dále ve vertex shaderu získáme pozici vrcholu kù¾e násobením maticí $\mathbf{T}$ a odpovídající vahou pro ètyøi pøiøazené kosti. Pøepoèítáváme také normálu, viz kód \ref{animation_shader}.

\begin{lstlisting}[float,floatplacement=H,language=GLSL, caption={Ukázka z vertex shaderu pro animovaný model. Výpoèet pro pozici a normálu se provede \(4 \times \), pro komponenty \texttt{x}, \texttt{y}, \texttt{z} a \texttt{w} vektorù \texttt{v\_weights} a \texttt{v\_joints}.}, label={animation_shader}]
vec4 pos = vec4(0.0);
pos += T[v_joints.x] * vec4(v_pos, 1.0) * v_weights.x;
/* ... */
vec3 norm = vec3(0.0);
norm += ti_T[v_joints.x] * v_norm * v_weights.x;
/* ... */
gl_Position = mvp * vec4(pos.xyz, 1.0);
\end{lstlisting}

Následuje zobrazení kostry. Pro ka¾dou kost se pou¾ije shodný model. Pro kosti se pou¾ívají globální matice shodné jako pøi zobrazování kù¾e, ale je v nich zapoèítané zvìt¹ení, aby na sebe kosti navazovaly.  Výsledná transformaèní matice kosti je koøenová transformace vynásobená s touto globální maticí kosti. Pøed zobrazením je vyèi¹tìn hloubkový buffer, aby se kostra pøekreslila pøes kù¾i. Pro zobrazení jsou pou¾ity difuzní textury a Phongùv osvìtlovací model. Výsledný výstup je na obrázku \ref{graphical_output}.

\begin{figure}[h]
\begin{center}
\subfloat{{\includegraphics[width=5cm]{fig/rigged.png}}}
\qquad
\subfloat{{\includegraphics[width=7cm]{fig/joker.png}}}
\caption{Grafický výstup aplikace pro dva rùzné modely. Model \cite{male_mesh} vlevo je v bind pose a model \cite{venom} vpravo má rotované nìkteré kosti (uvnitø kódu).} \label{graphical_output}
\end{center}
\end{figure}

\section{Animace}
Popis animace je rozdìlen na pohyb nohu, pánve a horní poloviny tìla. Ve v¹ech tìchto èástech je potøeba urèovat rotace a trajektorie kloubù. K tomu slou¾í Bézierovy køivky. Dále jsou v této kapitole popsány mo¾nosti nastavování parametrù.

Pohyb koøene kostry, pánve, bude aproximován pomocí interpolaèního Catmull-Rom splinu, podobnì jako na obrázku \ref{chung_pelvis}. Pro rotaci a náklon pánve budou vyu¾ity grafy na obrázku \ref{pelvic kinematics}. Pozice paty a prstù nohy se urèí ze znalostí fází chùze. Bìhem stadia zatì¾ování je pata na zemi a chodidlo je zvednuté a postupnì se dotýká zemì. V mezistoji bude chodidlo nehybné. Bìhem koneèného stoje a pøed¹vihové fáze jsou prsty nehybnì na zemi a zvedá se pata, a¾ se nakonec zvednou i prsty. V následujících fázích se poloha chodidla pøesouvá postupnì do polohy, kterou bude mít v poèáteèním kontaktu. Rotace kotníku se aproximuje pomocí interpolaèních splinù, viz obr \ref{ankle_kinematics}. Rotace kyèle a kolene se dopoèítá pomocí inverzní kinematiky, pou¾ije se metoda CCD (kapitola \ref{ccd}). Horní konèetiny se budou hýbat opaènì k dolním konèetinám v rozsahu nastavitelným parametry.

\begin{figure}[h]
\begin{center}
\subfloat{{\includegraphics[width=6cm]{fig/pelvic_rotation.png}}}
\qquad
\subfloat{{\includegraphics[width=6cm]{fig/pelvic_tilt.png}}}
\caption{Rotace a náklon pánve v prùbìhu krokového cyklu. Pøevzato z \cite{biomechanika_chuze}} \label{pelvic kinematics}
\end{center}
\end{figure}

\begin{figure}[h]
\begin{center}
\scalebox{0.4}{\includegraphics{fig/ankle_kinematics.png}}
\caption{Kinematika hlezenního kloubu (kotníku). Pøevzato z \cite{biomechanika_chuze}.} \label{ankle_kinematics}
\end{center}
\end{figure}

\subsection{Bézierovy køivky}
Bézierovy køivky \cite{bezier_primer} jsou parametrické interpolaèní køivky. Ty nám umo¾ní pøesnou aproximaci s malým mno¾stvím kontrolních bodù. Zvolili jsme kubické Bézierovy køivky, které pou¾ívají ètyøi kontrolní body, kde køivka prochází pouze krajními. Dva prostøední body urèují tvar køivky. Segmenty tìchto køivek je mo¾né skládat za sebe. Jestli¾e chceme plynulou návaznost, je nutné zajistit aby tøetí bod pøedchozího segmentu a druhý následujícího byly kolineární. Máme-li parametr $t$ potom se pozice $\mathbf{B}$ na køivce urèí následovnì:
\begin{eqnarray}
\mathbf{B}(t) &=& (1 - t)^3\mathbf{P_0} + 3(1-t)^2 t\mathbf{P_1} + 3(1-t)t^2\mathbf{P_2} + t^3\mathbf{P_3}
\label{r.bezier}
\end{eqnarray}
kde $0 \leq t \leq 1$ a $\mathbf{P_0}$, $\mathbf{P_1}$, $\mathbf{P_2}$ a $\mathbf{P_3}$ jsou kontrolní body køivky.

Køivky, které chceme aproximovat jsou ve 2D prostoru. Potøebujeme pro konkrétní hodnotu $x$ získat odpovídající hodnotu $y$. Bézierovy køivky ale vrací hodnotu podle parametru $t$, který se nepohybuje po køivce lineárnì. Proto musíme pro na¹e $x$ urèit odpovídající $t$ a to poté pou¾ít pro získání $y$. To je mo¾né øe¹it tak, ¾e se urèí vìt¹í mno¾ství bodù na køivce (napø. 100) a pro ka¾dý se získá hodnota $x$. Kdy¾ je potom potøeba urèit $t$ pro nìjaké $x$  najde se vhodný interval a $t$ se urèí lineární interpolací. Proto¾e se ale na¹e køivky budou mìnit s nastavováním parametrù a nerovností terénu, toto øe¹ení není vhodné, proto¾e vy¾aduje pøi ka¾dé zmìnì pøepoèítat v¹echny hodnoty. Proto jsme zvolili øe¹ení numerickou metodou.

Jako metodu jsme zvolili metodu pro øe¹ení jedné nelineární rovnice Regula Falsi. Ta konverguje v¾dy a v na¹em pøípadì kdy øe¹í hladké a monotónní køivky i velmi rychle. Funguje na principu dìlení intervalu $\langle a, b \rangle$ na dvì obecnì rùzné èásti. Dìlícím bodem $x_k$ intervalu je prùseèík osy $\mathbf{x}$ s úseèkou spojující $[a,f(a)]$ a $[b,f(b)]$ urèený následovnì:
\begin{eqnarray}
x_k &=& b_k - \frac{b_k-a_k}{f(b_k)-f(a_k)}f(b_k)
\label{r.regula_falsi}
\end{eqnarray}
Výpoèet konèí jestli¾e $|x_k - x_{k-1}| < \epsilon$. Tato metoda najde v na¹em pøípadì odpovídající $t$ s dostateènou pøesností na cca 4 iterace.


\subsection{Pohyb nohou}
O pohyb nohou se stará tøída \texttt{Leg} její¾ hlavní metodou, která se volá ka¾dý snímek poté co je ji¾ pohnutá pánev je metoda \texttt{update}. Ta vyu¾ívá jediný parametr a tím je èas, o který se animace posunula. Jeden krokový cyklus nohy je nastaven na dobu trvání jedné vteøiny. Zrychlení nebo zpomalení kroku je dosa¾eno úpravou vstupního èasu. Tento vstupní èas je poté pøièten k promìnné \texttt{t}, která se pøi pøeteèení pøes 1 vteøinu vrací o vteøinu zpìt. Podle \texttt{t} se poté urèí v jaké fázi krokového cyklu se noha nachází a podle toho je urèen dal¹í postup.

Nemusíme rozli¹ovat v¹ech sedm fází cyklu, ale budou nám staèit ètyøi. Stádium zatì¾ovaní a mezistoj jsou nezmìnìny. Koneèný stoj a pøed¹vihová fáze jsou spojeny do jedné, proto¾e z pohledu animace se tyto fáze neli¹í, v obou je provádìn stejný úkon -- zvedání paty. Poslední tøi fáze (poèáteèní ¹vih, mezi¹vih a koneèný ¹vih) jsou také spojeny do jedné, budeme ji øíkat pouze ¹vihová. Tyto fáze je mo¾né spojit, proto¾e se celá ¹vihová fáze dá popsat spojitì pomocí trajektorie od odrazu palce do poèáteèního kontaktu.

Pro potøeby správného a pøesného urèování pohybu nohou potøebujeme znát pozici paty a prstù nohy. Pøesnì se tyto pozice nedají získat pouze z pozic kostí. Tyto pozice jsou závislé na pozici a rotaci chodidla. Potøebné informace o jejich pozici jsou získány z umístìní kostry pøed samotným provedením animace podle umístìní kostry v prostoru, viz obrázek \ref{pozice_paty}. Kdy¾ jsou získány paty a prstù nohy, jsou vynásobeny inverzní transformaèní maticí chodidla. Tím jsou získány relativní pozice vùèi chodidlu, z kterých je pozdìji mo¾né získat pøesnì pozici paty a prstù v závislosti na aktuální pozici chodila. Staèí vynásobit aktuální transformaèní maticí chodidla a tìchto relativních pozic.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/pozice_paty.pdf}
	\caption{Vstupní pozice modelu a jeho kostry. Pozice paty se nachází na ose $\mathbf{z}$ a $\mathbf{y}$. Pozice prstù nohy se nachází pod kloubem prstù nohy na ose z.}
	\label{fig:pozice_paty}
\end{figure}

Dùle¾itou podmínkou pro chùzi po nerovném terénu je mo¾nost získat informace o terénu na kterém se noha nachází. Terén je objekt, který je sdílený v¹emi souèástmi tìla, kteøí s ním potøebují pracovat. Pro nohu je dùle¾ité získat vý¹ku terénu pod patou nohy a úhel mezi chodidlem a terénem. Tento úhel se urèí pomocí skalárního souèinu mezi vektorem smìøujícím od paty k prstùm nohy a vektorem mezi pozicemi na terénu pod patou a pod prsty. 

\subsubsection{Stádium zatì¾ování}
Stádium zatì¾ování nastane pro $t < 0.12$. Pøed prvním vykonáním této fáze se dokonèí ¹vihová fáze. Proto¾e pøedchozí snímek se vykonával pro nìjaké $t \leq 1.0$ a v aktuálním snímku se pøesunul z ¹vihové fáze do stadia zatì¾ování s nìjakým $t >= 0.0$ je potøeba prvnì dokonèit pøedchozí fázi jako by èas byl roven 1. Kdybychom to neudìlali animace by nebyla tolik pøesná a plynulá, jak moc by záviselo na velikosti èasového kroku. Také je získán poèáteèní úhel mezi chodidlem a terénem. 

Poté se tato fáze zabývá zachováním pozice paty na terénu a sklápìním chodidla. Pozice a natoèení chodidla je závislé na pozici pánve. Pánev se v ka¾dém snímku pohne první, proto pøi øe¹ení nohy je noha na jiné pozici ne¾ byla v pøedchozím snímku. Pozice paty je závislá na rotaci chodidla. Rotace chodidla se v této fázi urèuje lineární interpolací mezi poèáteèním úhlem s terénem a nulovým úhlem. Poté co se urèí po¾adovaná rotace pro aktuální \texttt{t} je chodidlo do této pozice nastaveno. Nyní se mù¾e urèit rozdíl mezi aktuální pozicí paty a pøedchozí a z toho urèit po¾adovaná pozice kotníku, která je dosa¾ena pomocí inverzní kinematiky. Inverzní kinematika hýbe nohou a tím i mìní rotaci chodidla vùèi terénu. Proto je po jejím provedení potøeba znovu natoèit chodidlo do správného úhlu.

\subsubsection{Mezistoj}
Následující fáze mezistoj nastává pro $0.1 \leq t < 0.31$ a má za úkol udr¾et chodilo polo¾eno na zemi na stejné pozici. Je vykonávána podobnì jako pøedchozí fáze. Pøed prvním vykonáním je tedy prvnì dokonèeno stádium zatì¾ování. Rozdílem je, ¾e pohyb nevychází z paty, ale vychází z kotníku. Proto nám staèí si na zaèátku zapamatovat pozici kotníku a tu pou¾ít pro inverzní kinematiku. Není tedy pøed jejím provedením nutné nastavovat novou rotaci chodidla, ta je nastavena a¾ po provedení inverzní kinematiky tak, aby úhel mezi terénem byl nulový.

\subsubsection{Zvedání paty}
Zvedání paty nastává pro $0.31 \leq t < 0.62$. Pro èas do $t = 0.5$ pøi zvedání paty zùstává koleno pøevá¾nì propnuté, ve zbylém èase se zase koleno ohýbá. Aby tohoto bylo dosa¾eno není vhodné zvedat patu v celé fázi lineárnì. Také není vhodné ji rozdìlit na dvì samostatné èásti, zvedání paty by nepùsobilo plynule. Nejvhodnìj¹ím øe¹ení se zdá pou¾ití Bézierovy køivky, kde v první èásti se zvedá pata ménì a v druhé více, tak je celá fáze plynulá. Konkrétní tvar køivky (obr. \ref{heelRiseRot}) byl urèen experimentálnì tak aby tato fáze bylo dostateènì pøirozená. Také je u této køivky dùle¾itý sklon u konce fáze, který pøi vhodném zvolení zajistí co nejplynulej¹í pøechod do ¹vihové fáze, tzn. je dùle¾ité aby rychlost pohybu paty na konci této fáze a na zaèátku ¹vihové byly co nejpodobnìj¹í. Rychlost pohybu nohy ve ¹vihové fázi je závislá na délce kroku. Proto je celkový úhel o který je pata zvednutá zvìt¹ován se zvìt¹ující se délkou kroku. Mimo správnou návaznost je toto zvìt¹ování také nutné pro zvý¹ení efektivního dosahu nohy, aby vùbec del¹í krok byl umo¾nìn. Køivka úhlu zvedání paty je vytvoøena pro nejdel¹í mo¾ný dvojkrok, který je 1.8 metru dlouhý. Pro jiné délky kroku je vynásobena $c = (dvojkrok/1.8)^2$, tato hodnota byla také zji¹tìna experimentálnì, aby tato fáze vypadala pøirozenì.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.3\linewidth]{fig/heelRiseRot.pdf}
	\caption{Rotace  chodidla vùèi zemi pøi fázi zvedání paty pro délku dvojkroku 1.8 metru.}
	\label{fig:heelRiseRot}
\end{figure}

Samotné zvedání paty probíhá následovnì. Na zaèátku fáze se ulo¾í pozice prstù, která se bude udr¾ovat. Po zji¹tìní aktuální rotace chodidla se zemí se natoèí chodidlo do této polohy. Poté se pomocí inverzní kinematiky  posune kotník o rozdíl pùvodní a aktuální pozice prstù. Tím se kotník dostane do po¾adované polohy, ale prsty v pùvodní pozici nebudou, proto¾e inverzní kinematika zmìnila rotaci chodidla vùèi zemi a proto je chodidlo znovu natoèeno na správný úhel. Nakonec zbývá jenom natoèit prsty nohy, aby byly v nulovém úhlu se zemí, tzn. natoèit na rotaci odpovídající úhlu mezi chodidlem a zemí.

\subsubsection{©vihová fáze}
©vihová fáze nastává pro $0.62 \leq t \leq 1.0$. Jejím cílem je pøesunutí nohy z aktuální pozice na pozici dal¹ího kroku. V této fázi se vyu¾ívají ètyøi Bézierovy køivky. Pøi prvním vykonání této fáze se dokonèí fáze zvedání paty a zapamatuje se pozice paty, která bude slou¾it jako výchozí bod pro ¹vihovou fázi. V prùbìhu této fáze je také potøeba vrátit prsty na noze do pùvodní polohy, proto¾e pøi zvedání paty byly otoèeny. V první pìtinì ¹vihové fáze jsou prsty rotovány do pozice urèené lineární interpolací mezi otoèenou pozicí a pùvodní nata¾enou pozicí.

Podle \cite{chung} se chodidlo pohybuje vpøed s mìnící se rychlostí.  Rychlost je nejvy¹¹í uprostøed ¹vihové fáze a nejpomalej¹í na zaèátku a na konci. K tomu slou¾í Bézierova køivka urèující posun chodidla v horizontální rovinì, viz obrázek \ref{fig:swingSpeed}. Tato køivka je vytvoøena pro posun o délce 1 metr. Potom pro rùzné délky staèí pøed pou¾itím køivky její kontrolní body vynásobit po¾adovanou délkou. Jako délku nemù¾eme pou¾ít aktuální délku dvojkroku, to by se noha pøesouvala pøed po¾adovanou pozici. Je nutné vzít v úvahu, ¾e pøi zvedání paty se ji¾  pata posunuje vpøed. Noha zná pozici paty na zaèátku aktuálního kroku a pozici na kterou chceme aby pata dopadla pøi konci kroku, tedy zaèátku dal¹ího. Pata zùstává na stejné pozici pøi stádiu zatì¾ování a pøi mezistoji. Ale pøi zvedání paty se ji¾ pohybuje v horizontální rovinì a délka tohoto pohybu se musí odeèíst od délky dvojkroku, abychom získali pøesný zbývající posun nohy na cílovou pozici pro vynásobení Bézierovy køivky. Pro posun vpøed v horizontální rovinì poté staèí zjistit hodnotu køivky a pøièíst ji k pozici po ukonèení zvedání paty.

\begin{figure}[h]
	\centering
	\includegraphics[width=1.0\linewidth]{fig/leg_swing_speed.pdf}
	\caption{Vlevo jsou namìøené grafy posunu chodidla v èase pro chùzi po rovinì, z kopce a do kopce pøevzté z èlánku \cite{chung}. Vpravo je vytvoøená generická Bézierova køivka, která je pou¾ita pro posun nohy v horizontální rovinì.}
	\label{fig:swingSpeed}
\end{figure}

V prùbìhu chùze mù¾e být nastavena rùzná ¹íøka kroku. Není pøirozené, aby si chodidlo v prùbìhu celé ¹vihové fáze udr¾ovalo stejnou vzdálenost od ¹íøky od pánve. Pùsobí mnohem vìrohodnìji pokud se chodidlo po odrazu od zemì pøesune na ¹íøku kyèle, které dosáhne v polovinì ¹vihové fáze a poté se zaène pøesouvat zpìt na ¹íøku kroku, které dosáhne v okam¾iku dopadu paty. Toho by bylo mo¾né dosáhnout lineární interpolací mezi ¹íøkou kroku a pozicí kyèle. Tímto zpùsobem ale animace není plynulá kvùli náhlému zrychlení nohy pøi odrazu paty a zastavení pøi dopadu. Proto jsme vytvoøili dal¹í Bézierovu køivku, která se pou¾ije pro plynulé zrychlení a zpomalení tohoto pohybu, viz obrázek \ref{fig:widthStep}. Èasový parametr lineární interpolace se pou¾ije pro získání hodnoty této køivky, která se pou¾ije místo nìj.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/svih_sirka_kroku.pdf}
	\caption{Pøesun chodidla bìhem ¹vihové fáze v závislosti na ¹íøce kroku.}
	\label{fig:widthStep}
\end{figure}

Takto jsou získány dva údaje ze ètyø, které jsou potøeba pro urèení pozice chodidla ve ¹vihové fázi. Máme pozici paty do ¹íøky, vpøed a dále potøebujeme vý¹ku a rotaci chodidla. Kdy¾ máme v¹echny tyto ètyøi údaje mù¾eme nastavit správnou rotaci v kotníku, poté z ní urèit novou pozici kotníku tak, aby pata byla na správné pozici podle na¹í urèené ¹íøky, vý¹ky a posunu vpøed. S touto novou pozicí kotníku se spoèítá inverzní kinematika. Zbylé dva údaje rotace a vý¹ky chodidla je ale nutné pøizpùsobit nerovnému terénu.

Pro rotaci chodidla v prùbìhu ¹vihové fáze vycházíme z obrázku \ref{fig:ankleRot}, kde je uvedena rotace v kotníku v prùbìhu celého cyklu. Èást toho grafu ve ¹vihové fázi je aproximována pomocí Bézierovy køivky. Tato køivka zaèíná pro 15 stupòù plantární flexe, tedy propnutí kotníku z neutrální polohy, a konèí u pøibli¾nì neutrální polohy. Tuto køivku je tedy nutné pøizpùsobit propnutí kotníku na zaèátku ¹vihové fáze, které se mù¾e li¹it v závislosti na délce kroku a sklonu terénu. Kontrolní body køivky jsou proto vynásobeny koeficientem $c = aktRot / 15\degree$, kde $aktRot$ je aktuální propnutí v kotníku. 

\begin{figure}[h]
	\centering
	\includegraphics[width=0.9\linewidth]{fig/ankle_kinematics.png}
	\caption{Rotace kotníku v prùbìhu krokového cyklu. Pøevzato z \cite{biomechanika_chuze}.}
	\label{fig:ankleRot}
\end{figure}

Nyní je potøeba vyøe¹it úhel dopadu chodidla na terén.  Jedna mo¾nost je mít pevnì daný úhel, pod kterým bude chodidlo dopadat v¾dy. Zdá se ale pøirozenìj¹í nechat úhel podle na¹í køivky a upravit ho jenom v nevhodných pøípadech. Tímto pøípadem je mo¾nost prùchodu chodidla skrz terén pøi sklonu do kopce, viz obrázek \ref{fig:swingRotFix}. Poté je rotace upravena aby pøi dopadu byl sklon chodidla shodný s terénem. 

\begin{figure}[h]
	\centering
	\includegraphics[width=0.6\linewidth]{fig/foot_through_terrain.pdf}
	\caption{Pozice chodidla na terénu pøi dopadu paty s pùvodní rotací a po úpravì rotace.}
	\label{fig:swingRotFix}
\end{figure}

Kvùli tomu je pøed samotným provedením kroku vyzkou¹ena pozice na konci kroku pøi dopadu paty. To vy¾aduje urèení transformaèní rotace pánve pøi dopadu paty a posunutí nohy na cílovou pozici pomocí inverzní kinematiky. Poté je zkontrolován úhel mezi chodidlem a terénem a jestli¾e je záporný, tzn. chodidlo se nachází pod terénem je upravena køivka rotace. Potøebujeme upravit pouze koncový úhel propnutí kotníku a proto jsou o potøebný úhel posunuty poslední dva kontrolní body køivky.

Poslední co je potøeba urèit je vý¹ka chodidla. K tomu slou¾í poslední Bézierova køivka pou¾itá pro pohyb nohy, viz obrázek \ref{fig:swingHeight}. Tato køivka urèuje vý¹ku paty a skládá se ze tøí segmentù, to nám umo¾òuje køivku dobøe tvarovat pøi pøizpùsobování se nerovnému terénu. Obdobnì jako pøi rotaci chodidla je tato køivka vytvoøena pro jeden pøípad a poté upravena. Konkrétnì je vytvoøena pro patu nacházející se 20 centimetrù nad terénem pøi poèátku ¹vihové fáze. Pro pøípady kdy se pata nachází vý¹e nebo ní¾e jsou v¹echny kontrolní body vynásobeny koeficientem, který zajistí aby vý¹ka paty odpovídala a ¹vihová fáze plynule navazovala na zvedání paty.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\linewidth]{fig/legSwingCurve_excel.pdf}
	\caption{Trajektorie paty pøi ¹vihové fázi pro chùzi po rovném terénu.}
	\label{fig:swingHeight}
\end{figure}

\subsubsection{Inverzní kinematika}
Jak je nastven ref. vektor.-

Kinematický øetìzec který potøebujeme øe¹it obsahuje pouze dva klouby -- kyèel a koleno. Pro takový øetìzec existuje rychlé analytické øe¹ení. Pozici kyèle známe a po¾adovanou cílovou pozici koncového efektoru (kotníku) také. Kromì toho známe i délku stehenní a holenní kosti. Rotace kyèle a kolene se poté dopoèítá jako úhly v trojúhelníku pomocí kosinové vìty.

Tímto je¹tì není inverzní kinematika vyøe¹ená, proto¾e mù¾e být nekoneènì mnoho øe¹ení s rùznými rotacemi okolo osy mezi kyèlí a kotníkem, viz obrázek \ref{fig:analytical_IK}. K tomu abychom urèili výslednou rotaci okolo této osy slou¾í referenèní vektor \cite{analytic_IK}. Výsledné øe¹ení se poté vybere takové, aby úhel $\delta$ mezi referenèním vektorem a stehenní kostí byl co nejmen¹í. Proto budeme rotovat vektor $\mathbf{v}$ o úhel $\theta$ do nového vektoru $\mathbf{v}'$. Minimalizace úhlu $\delta$ je ekvivalentní maximalizaci $\cos\delta$ (resp. $\mathbf{v}'\cdot \mathbf{k}$) a to nastane kdy¾ je první derivace rovna nule:
\begin{eqnarray}
\frac{d}{d\theta}\mathbf{v}'\cdot \mathbf{k} &=& 0
\label{r.IK_derivation}
\end{eqnarray}
Po úpravì dostaneme:
\begin{eqnarray}
\theta = \tan^{-1}\frac{2 B}{C-A} &\vee & \theta = \pi + \tan^{-1}\frac{2 B}{C-A}
\label{r.IK_derivation2}
\end{eqnarray}
kde $A = (\mathbf{a}\cdot \mathbf{v})\mathbf{a} \cdot \mathbf{k} - ((\mathbf{a} \times \mathbf{v})\times \mathbf{a})\cdot \mathbf{k})$, $B = (\mathbf{a} \times \mathbf{v})\cdot \mathbf{k}$ a $C = \mathbf{v}\cdot \mathbf{k}$. Abychom urèili, které ze dvou øe¹ení maximalizuje $\cos\delta$ musíme urèit druhou derivaci $\cos\delta$:
\begin{eqnarray}
\frac{d^2}{d\theta^2}\cos\delta &=& \frac{A-C}{2} \cos\theta - B\sin\theta
\label{r.IK_derivation3}
\end{eqnarray}
Úhel $\delta$ je minimální, kdy¾ je druhá derivace men¹í ne¾ nula.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.4\linewidth]{fig/analytical_IK.pdf}
	\caption{Pro dosa¾ení cílové pozice v kotníku se pomocí kosinové vìty urèí úhly v kyèli a v koleni. Rotace okolo osy mezi kyèlí a kotníkem se urèí tak, aby úhel  $\delta$ byl co nejmen¹í.}
	\label{fig:analytical_IK}
\end{figure}

Pomocí kosinové vìty jsme pro stehenní kost urèili úhel $\alpha_1$, který urèuje rotaci mezi vektorem $\mathbf{a}$ a stehenní kostí $\mathbf{v}$. Abychom nastavili kost do správné pozice, je potøeba vektor $\mathbf{v}$ natoèit do $\mathbf{a}$. K tomu je sestavena transformaèní matice, jejím¾ vynásobením se $\mathbf{v}$ dostane do $\mathbf{a}$. Poté je ji¾ mo¾né rotovat kyèel o úhel $\alpha_1$. Nyní u¾ je pouze rotována holeò do úhlu $\alpha_2$ a stehno rotováno o $\theta$ okolo vektoru $\mathbf{a}$.

Øe¹ení inverzní kinematiky rotuje holeò okolo osy $\mathbf{x}$ a tedy aby  výsledná pozice kotníku odpovídala té po¾adované, noha nemù¾e být libovolnì natoèena vùèi své rodièovské kosti (stehna). Vstupní model mù¾e mít koleno rùznì natoèené a proto pøed samotným zaèátkem animace je nutné lokální matici holenì zbavit v¹ech rotací a zachovat pouze translaci.


\chapter{Závìr}
Byla pøedstavena skeletální animace a metody tvorby animace. Definovány kinematiky a popsány nìkteré metody øe¹ení inverzní kinematiky. Dále byly popsány fáze lidské chùze a nìkterá existující øe¹ení procedurální animace chùze. Následnì byl popsán návrh a implementace èástí øe¹ení. 

V rámci semestrálního projektu  bylo implementováno naètení modelu èlovìka spolu s pøipojenou kostrou a jeho zobrazení. Výsledná aplikace má pøes 2000 øádkù kódu. V rámci dal¹ího vývoje bude potøeba implementovat systém tvorby animace a její vyexportování do souboru.


%=========================================================================
